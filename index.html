<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¨å›½æ•£ç­–ãƒãƒƒãƒ— â€” ãƒã‚¤ã‚­ãƒ³ã‚°ãƒ»ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã‚³ãƒ¼ã‚¹è¨ºæ–­</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden;font-family:"Hiragino Sans","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
    body{display:flex;background:#eee}
    .hidden{display:none!important}

    /* ========== MAIN MAP ========== */
    #main-map{flex:1;height:100vh;z-index:1}

    /* ========== SIDEBAR (PC) ========== */
    .sidebar{width:380px;height:100vh;background:#fff;display:flex;flex-direction:column;box-shadow:2px 0 12px rgba(0,0,0,.15);z-index:10;flex-shrink:0;transition:margin-left .3s ease;position:relative}
    .sidebar.collapsed{margin-left:-380px}
    .sidebar-header{padding:12px 16px;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;display:flex;align-items:center;gap:10px;flex-shrink:0}
    .sidebar-title{font-size:15px;font-weight:700;flex:1}
    .sidebar-toggle{background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:background .2s}
    .sidebar-toggle:hover{background:rgba(255,255,255,.35)}
    .sidebar-drag{display:none}
    .sidebar-body{flex:1;overflow-y:auto;overflow-x:hidden}
    /* sidebar re-open button on map */
    .sidebar-reopen{position:fixed;top:12px;left:12px;z-index:20;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.3);display:none}

    /* ========== SIDEBAR VIEWS ========== */
    .sb-view{padding:16px;animation:fadeIn .25s ease}
    #sb-landing{padding:0}
    .sb-view.hidden{display:none!important}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* ========== LANDING VIEW ========== */
    .sb-hero{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #e8ede8;background:linear-gradient(135deg,#f0faf4,#e8f5e9)}
    .sb-hero-text{flex:1;font-size:11px;color:#555;line-height:1.5}
    .sb-hero-text strong{color:#1b4332;font-size:12px}
    .btn-diag{background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;border:none;padding:7px 14px;border-radius:18px;font-size:12px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(27,67,50,.25);transition:all .2s;white-space:nowrap;flex-shrink:0}
    .btn-diag:hover{box-shadow:0 3px 12px rgba(27,67,50,.4);transform:translateY(-1px)}

    /* ========== FILTERS ========== */
    .sb-filters{padding:14px 16px;border-bottom:1px solid #e8ede8}
    .filter-group{margin-bottom:10px}
    .filter-group:last-child{margin-bottom:0}
    .filter-label{font-size:11px;font-weight:700;color:#555;display:block;margin-bottom:5px}
    .filter-btns{display:flex;flex-wrap:wrap;gap:5px}
    .fbtn{padding:5px 10px;border:1.5px solid #dce4dc;border-radius:7px;background:#f8faf8;font-size:11px;color:#555;cursor:pointer;transition:all .15s;font-weight:600}
    .fbtn:hover{border-color:#52b788;background:#edf7f0}
    .fbtn.active{border-color:#2d6a4f;background:#2d6a4f;color:#fff}
    .filter-count{font-size:12px;color:#888;padding:8px 16px 0;text-align:right}

    /* ========== SEARCH ========== */
    .sb-search{padding:10px 16px;border-bottom:1px solid #e8ede8}
    .search-box{display:flex;align-items:center;gap:6px;background:#f5f7f5;border:1.5px solid #dce4dc;border-radius:8px;padding:7px 10px;transition:border-color .2s}
    .search-box:focus-within{border-color:#2d6a4f;background:#fff}
    .search-icon{font-size:14px;flex-shrink:0}
    #search-input{flex:1;border:none;background:transparent;font-size:13px;outline:none;color:#333;font-family:inherit;min-width:0}
    #search-input::placeholder{color:#aaa}
    .search-clear{background:none;border:none;color:#999;font-size:14px;cursor:pointer;padding:0 2px;flex-shrink:0}
    .search-clear:hover{color:#555}
    .sb-ccard-match{padding:3px 10px 5px;font-size:10px;color:#e65100;background:#fff8f0;border-top:1px solid #ffe0b2}

    /* ========== SEARCH PRESETS ========== */
    .sb-presets{padding:12px 16px;border-bottom:1px solid #e8ede8}
    .preset-cat{margin-bottom:10px}
    .preset-cat:last-child{margin-bottom:0}
    .preset-cat-name{font-size:10px;font-weight:700;color:#888;margin-bottom:5px;display:flex;align-items:center;gap:4px}
    .preset-btns{display:flex;flex-wrap:wrap;gap:4px}
    .preset-btn{padding:4px 9px;border:1.5px solid #e8ede8;border-radius:14px;background:#fff;font-size:11px;color:#555;cursor:pointer;transition:all .15s;white-space:nowrap}
    .preset-btn:hover{border-color:#52b788;background:#edf7f0;color:#2d6a4f}
    .preset-btn.active{border-color:#2d6a4f;background:#e8f5e9;color:#1b4332;font-weight:600}

    /* ========== COURSE LIST ========== */
    .sb-course-list{padding:8px 12px}
    .sb-ccard{border:1px solid #e4e8e4;border-radius:10px;overflow:hidden;cursor:pointer;transition:all .15s;margin-bottom:8px}
    .sb-ccard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);border-color:#52b788}
    .sb-ccard.highlighted{border-color:#2d6a4f;box-shadow:0 0 0 2px rgba(45,106,79,.25)}
    .sb-ccard-h{padding:7px 10px;color:#fff;display:flex;justify-content:space-between;align-items:center}
    .sb-ccard-h h4{font-size:12px;font-weight:700;flex:1;margin-right:6px}
    .sb-ccard-h .eq-tag{font-size:10px;background:rgba(255,255,255,.25);padding:2px 6px;border-radius:4px;white-space:nowrap}
    .sb-ccard-b{padding:6px 10px;font-size:11px;color:#666;display:flex;gap:8px;flex-wrap:wrap}
    .sb-ccard-b span{white-space:nowrap}
    .sb-ccard-desc{padding:4px 10px 7px;font-size:11px;color:#555;line-height:1.5;border-top:1px solid #eee}
    .sb-more{text-align:center;color:#999;font-size:11px;padding:10px}

    /* ========== MAP LEGEND (on map) ========== */
    .map-legend-ctrl{display:flex;gap:8px;background:#fff;padding:6px 10px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,.2);font-size:11px;color:#555}
    .map-legend-ctrl .ld{display:flex;align-items:center;gap:3px}
    .map-legend-ctrl .ldot{width:10px;height:10px;border-radius:50%;border:1.5px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.3)}

    /* ========== QUIZ / PREF SELECTOR ========== */
    .sb-back{background:none;border:none;color:#2d6a4f;font-size:13px;font-weight:600;cursor:pointer;padding:0 0 10px;display:inline-block}
    .sb-back:hover{text-decoration:underline}
    .pref-sec{padding:4px 0}
    .q-num{display:inline-block;background:#e8f5e9;color:#2d6a4f;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;margin-bottom:8px}
    .q-txt{font-size:15px;font-weight:700;color:#1b4332;margin-bottom:14px;line-height:1.5}
    .pref-region{margin-bottom:14px}
    .pref-region-name{font-size:12px;font-weight:700;color:#2d6a4f;margin-bottom:6px;padding-left:2px}
    .pref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:5px}
    .pref-btn{padding:7px 4px;border:1.5px solid #dce4dc;border-radius:8px;background:#f8faf8;font-size:11px;color:#444;cursor:pointer;text-align:center;transition:all .15s;font-weight:600}
    .pref-btn:hover{border-color:#52b788;background:#edf7f0}
    .pref-btn.selected{background:#2d6a4f;color:#fff;border-color:#2d6a4f}

    .prog{margin-bottom:14px}
    .prog-top{display:flex;justify-content:space-between;font-size:11px;color:#777;margin-bottom:4px}
    .prog-bar{height:5px;background:#e8ede8;border-radius:3px;overflow:hidden}
    .prog-fill{height:100%;background:linear-gradient(90deg,#2d6a4f,#52b788);border-radius:3px;transition:width .3s}

    .opts{display:flex;flex-direction:column;gap:7px}
    .opt-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid #dce4dc;border-radius:10px;background:#fff;cursor:pointer;transition:all .15s;text-align:left;font-size:13px}
    .opt-btn:hover{border-color:#52b788;background:#edf7f0;transform:translateX(3px)}
    .oi{font-size:20px;flex-shrink:0}
    .ol{flex:1;color:#333}

    /* ========== RESULT VIEW ========== */
    .r-sec{padding:4px 0}
    .r-badge{display:inline-block;font-size:13px;font-weight:700;padding:6px 14px;border-radius:20px;margin-bottom:8px}
    .lv-entry{background:#e8f5e9;color:#388e3c}
    .lv-beginner{background:#e8f5e9;color:#2e7d32}
    .lv-intermediate{background:#fff8e1;color:#f57f17}
    .lv-advanced{background:#fbe9e7;color:#d84315}
    .lv-expert{background:#f3e5f5;color:#6a1b9a}
    .r-region{font-size:14px;font-weight:700;color:#1b4332;margin-bottom:6px}
    .r-sum{font-size:13px;color:#555;line-height:1.6;margin-bottom:12px;padding:10px;background:#f8faf8;border-radius:10px}
    .r-sum p{margin:0}

    .cards{display:flex;flex-direction:column;gap:10px}
    .card{border-radius:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.08);transition:all .2s;border:1px solid #e8ede8}
    .card:hover{box-shadow:0 3px 12px rgba(0,0,0,.12)}
    .card-h{padding:10px 14px;color:#fff;display:flex;justify-content:space-between;align-items:center;border-radius:10px 10px 0 0}
    .card-h h3{font-size:14px;font-weight:700;flex:1}
    .diff-tag{font-size:10px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px;white-space:nowrap}
    .niche-b,.stroll-b{font-size:10px;padding:1px 6px;border-radius:4px;margin-left:6px}
    .niche-b{background:rgba(123,31,162,.2);color:#e1bee7}
    .stroll-b{background:rgba(0,121,107,.2);color:#b2dfdb}
    .now-tag{font-size:9px;background:#ff6f00;color:#fff;padding:2px 6px;border-radius:4px;margin-left:6px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .card-b{padding:12px 14px}
    .c-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:#666;margin-bottom:8px}
    .c-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
    .tag{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
    .tag-highlight{background:#fff3e0;color:#e65100}
    .tag-niche{background:#f3e5f5;color:#7b1fa2}
    .tag-view{background:#e3f2fd;color:#1565c0}
    .tag-nature{background:#e8f5e9;color:#2e7d32}
    .tag-season{background:#fce4ec;color:#c62828}
    .tag-stroll{background:#e0f2f1;color:#00695c}
    .c-desc{font-size:12px;color:#444;line-height:1.6;margin-bottom:8px}
    .c-tips{font-size:11px;color:#666;background:#f8faf8;padding:8px 10px;border-radius:8px;line-height:1.5}

    .season-indicator{margin-bottom:6px}
    .si-badge{display:inline-block;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px}
    .si-highlight{background:#fff3e0;color:#e65100}
    .si-best{background:#e8f5e9;color:#2e7d32}
    .si-ok{background:#f5f5f5;color:#666}
    .si-offseason{background:#f5f5f5;color:#999}
    .highlight-text{font-size:11px;color:#e65100;margin-left:4px}

    .stroll-note,.nearby-note{font-size:12px;padding:10px;border-radius:8px;margin-bottom:4px}
    .stroll-note{background:#e0f2f1;color:#00695c}
    .nearby-note{background:#e3f2fd;color:#1565c0}

    .season-panel{border-radius:10px;overflow:hidden;margin-bottom:12px;border:1px solid #e0e0e0}
    .season-header{padding:12px 14px;display:flex;align-items:center;gap:10px;color:#fff}
    .spring-bg{background:linear-gradient(135deg,#f48fb1,#f06292)}
    .summer-bg{background:linear-gradient(135deg,#26a69a,#00897b)}
    .autumn-bg{background:linear-gradient(135deg,#ff8a65,#f4511e)}
    .winter-bg{background:linear-gradient(135deg,#64b5f6,#1e88e5)}
    .s-icon{font-size:24px}
    .s-title{font-size:13px;font-weight:700}
    .s-month{font-size:11px;opacity:.85}
    .season-body{padding:12px 14px;font-size:12px;color:#444;line-height:1.6}
    .season-summary{margin-bottom:6px}
    .season-warn{color:#c62828;margin-bottom:6px}
    .season-recommend{color:#2e7d32;margin-bottom:6px}
    .level-season-note{color:#1565c0;background:#e3f2fd;padding:6px 8px;border-radius:6px}

    .btn-restart{display:block;width:100%;padding:10px;border:2px solid #2d6a4f;border-radius:10px;background:#fff;color:#2d6a4f;font-size:13px;font-weight:600;cursor:pointer;margin-top:8px;transition:all .15s}
    .btn-restart:hover{background:#2d6a4f;color:#fff}

    /* ========== MAP CONTROLS (reused) ========== */
    .gmap-layer-ctrl{display:flex;gap:0;border-radius:8px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.2);font-family:"Hiragino Sans","Noto Sans JP",sans-serif}
    .gmap-layer-btn{padding:7px 14px;font-size:12px;font-weight:600;border:none;cursor:pointer;color:#444;background:#fff;transition:background .15s,color .15s;white-space:nowrap}
    .gmap-layer-btn:hover{background:#f0f0f0}
    .gmap-layer-btn.active{background:#e8f5e9;color:#1b4332;border-bottom:2px solid #2d6a4f}
    .map-popup-title{font-size:14px;font-weight:700;color:#1b4332;margin-bottom:4px}
    .map-popup-meta{font-size:12px;color:#666;line-height:1.5}
    .map-popup-season{font-size:11px;margin-top:4px}
    .marker-dot{border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4)}
    .marker-season{position:relative}
    .marker-season::after{content:"";position:absolute;top:-4px;left:-4px;right:-4px;bottom:-4px;border-radius:50%;border:2px solid #ff6f00;animation:markerPulse 2s infinite;pointer-events:none}
    @keyframes markerPulse{0%{transform:scale(1);opacity:.8}50%{transform:scale(1.6);opacity:0}100%{transform:scale(1);opacity:0}}
    .marker-season-label{position:absolute;top:-20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ff6f00,#ff8f00);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;white-space:nowrap;pointer-events:none}

    /* ========== MOBILE (bottom sheet) ========== */
    @media(max-width:768px){
      body{flex-direction:column;position:relative}
      #main-map{width:100%;height:100vh;position:fixed;top:0;left:0}
      .sidebar{position:fixed;bottom:0;left:0;right:0;width:100%;height:auto;max-height:80vh;border-radius:16px 16px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.2);z-index:100;transition:transform .3s ease;transform:translateY(0)}
      .sidebar.collapsed{transform:translateY(calc(100% - 56px))}
      .sidebar-drag{display:block;width:40px;height:4px;background:#ccc;border-radius:2px;margin:8px auto 0;flex-shrink:0}
      .sidebar-toggle{display:none}
      .sidebar-reopen{display:none!important}
      .gmap-layer-btn{padding:5px 10px;font-size:11px}
      .pref-grid{grid-template-columns:repeat(auto-fill,minmax(52px,1fr))}
      .pref-btn{padding:6px 2px;font-size:10px}
      .mobile-fab{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:50;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;font-size:14px;font-weight:600;padding:12px 24px;border:none;border-radius:30px;box-shadow:0 4px 16px rgba(27,67,50,.4);cursor:pointer}
    }
    @media(min-width:769px){
      .mobile-fab{display:none!important}
    }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-drag" id="drag-handle"></div>
  <div class="sidebar-header">
    <span style="font-size:18px">ğŸ—¾</span>
    <span class="sidebar-title">å…¨å›½æ•£ç­–ãƒãƒƒãƒ—</span>
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">â—€</button>
  </div>
  <div class="sidebar-body" id="sidebar-body">

    <!-- LANDING VIEW -->
    <div id="sb-landing" class="sb-view">
      <div class="sb-hero">
        <div class="sb-hero-text"><strong>ã‚ãªãŸã«åˆã†ã‚³ãƒ¼ã‚¹ã¯ï¼Ÿ</strong><br>ä½“åŠ›ãƒ»çµŒé¨“ã‹ã‚‰ãŠã™ã™ã‚ã‚’è¨ºæ–­</div>
        <button class="btn-diag" onclick="startQuiz()">ğŸ“‹ è¨ºæ–­ã™ã‚‹</button>
      </div>
      <div class="sb-search">
        <div class="search-box">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="search-input" placeholder="ã‚³ãƒ¼ã‚¹åãƒ»è¦‹ã©ã“ã‚ã§æ¤œç´¢â€¦" oninput="onSearchInput(this.value)">
          <button class="search-clear hidden" id="search-clear" onclick="clearSearch()">âœ•</button>
        </div>
      </div>
      <div class="sb-presets" id="sb-presets">
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸŒ¸ å­£ç¯€ã®èŠ±ãƒ»æ¤ç‰©</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'æ¡œ')">æ¡œ</button>
            <button class="preset-btn" onclick="applyPreset(this,'ç´…è‘‰')">ç´…è‘‰</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ–°ç·‘')">æ–°ç·‘</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ¢…')">æ¢…</button>
            <button class="preset-btn" onclick="applyPreset(this,'ãƒ„ãƒ„ã‚¸')">ãƒ„ãƒ„ã‚¸</button>
            <button class="preset-btn" onclick="applyPreset(this,'ã‚¢ã‚¸ã‚µã‚¤')">ã‚¢ã‚¸ã‚µã‚¤</button>
          </div>
        </div>
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸ”ï¸ è‡ªç„¶ã®è¦‹ã©ã“ã‚</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'æ¸“è°·')">æ¸“è°·</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ»')">æ»</button>
            <button class="preset-btn" onclick="applyPreset(this,'æµ·')">æµ·</button>
            <button class="preset-btn" onclick="applyPreset(this,'å¯Œå£«å±±')">å¯Œå£«å±±</button>
            <button class="preset-btn" onclick="applyPreset(this,'é«˜åŸ')">é«˜åŸ</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ£®æ—æµ´')">æ£®æ—æµ´</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ¹–')">æ¹–</button>
          </div>
        </div>
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸ¯ æ­´å²ãƒ»æ–‡åŒ–</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'ç¥ç¤¾')">ç¥ç¤¾</button>
            <button class="preset-btn" onclick="applyPreset(this,'å¯º')">å¯º</button>
            <button class="preset-btn" onclick="applyPreset(this,'åŸ')">åŸ</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ¸©æ³‰')">æ¸©æ³‰</button>
            <button class="preset-btn" onclick="applyPreset(this,'ä¸–ç•Œéºç”£')">ä¸–ç•Œéºç”£</button>
          </div>
        </div>
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸ¥¾ ã‚³ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'ã”å½“åœ°ã‚¢ãƒ«ãƒ—ã‚¹')">ã”å½“åœ°ã‚¢ãƒ«ãƒ—ã‚¹</button>
            <button class="preset-btn" onclick="applyPreset(this,'ãƒ­ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«')">ãƒ­ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«</button>
            <button class="preset-btn" onclick="applyPreset(this,'é–¢æ±ãµã‚Œã‚ã„ã®é“')">é–¢æ±ãµã‚Œã‚ã„ã®é“</button>
            <button class="preset-btn" onclick="applyPreset(this,'ç™¾åå±±')">ç™¾åå±±</button>
            <button class="preset-btn" onclick="applyPreset(this,'å±•æœ›')">å±•æœ›</button>
            <button class="preset-btn" onclick="applyPreset(this,'ç¸¦èµ°')">ç¸¦èµ°</button>
          </div>
        </div>
      </div>
      <div class="sb-filters">
        <div class="filter-group">
          <label class="filter-label">è£…å‚™åŸºæº–</label>
          <div class="filter-btns">
            <button class="fbtn active" data-val="all" onclick="handleFilter(this,'equipment')">ã™ã¹ã¦</button>
            <button class="fbtn" data-val="casual" onclick="handleFilter(this,'equipment')">ğŸ‘Ÿ ç§æœã§æ­©ã‘ã‚‹</button>
            <button class="fbtn" data-val="hiking" onclick="handleFilter(this,'equipment')">ğŸ¥¾ ç™»å±±è£…å‚™ãŒå¿…è¦</button>
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">æ‰€è¦æ™‚é–“</label>
          <div class="filter-btns">
            <button class="fbtn active" data-val="all" onclick="handleFilter(this,'duration')">ã™ã¹ã¦</button>
            <button class="fbtn" data-val="under1h" onclick="handleFilter(this,'duration')">ã€œ1æ™‚é–“</button>
            <button class="fbtn" data-val="1to3h" onclick="handleFilter(this,'duration')">1ã€œ3æ™‚é–“</button>
            <button class="fbtn" data-val="3to5h" onclick="handleFilter(this,'duration')">3ã€œ5æ™‚é–“</button>
            <button class="fbtn" data-val="halfday" onclick="handleFilter(this,'duration')">åŠæ—¥ä»¥ä¸Š</button>
            <button class="fbtn" data-val="overnight" onclick="handleFilter(this,'duration')">1æ³Šä»¥ä¸Š</button>
          </div>
        </div>
      </div>
      <div class="filter-count" id="filter-count"></div>
      <div class="sb-course-list" id="sb-course-list"></div>
    </div>

    <!-- PREF VIEW -->
    <div id="sb-pref" class="sb-view hidden"></div>

    <!-- QUIZ VIEW -->
    <div id="sb-quiz" class="sb-view hidden">
      <button class="sb-back" onclick="backToLanding()">â† æˆ»ã‚‹</button>
      <div class="prog">
        <div class="prog-top"><span id="p-txt"></span><span id="p-pct"></span></div>
        <div class="prog-bar"><div class="prog-fill" id="p-fill"></div></div>
      </div>
      <div id="q-box"></div>
    </div>

    <!-- RESULT VIEW -->
    <div id="sb-result" class="sb-view hidden"></div>
  </div>
</div>

<!-- SIDEBAR REOPEN (PC only, shown when sidebar collapsed) -->
<button class="sidebar-reopen" id="sidebar-reopen" onclick="toggleSidebar()">â˜° ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

<!-- MAIN MAP -->
<div id="main-map"></div>

<!-- MOBILE FAB (shown when sidebar collapsed on mobile) -->
<button class="mobile-fab hidden" id="mobile-fab" onclick="startQuiz();expandSidebar()">ğŸ“‹ è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="mountains.js?v=20260217i"></script>
<script>
// ============ QUESTIONS ============
const questions=[
  {id:"exercise",text:"æ™®æ®µã®é‹å‹•ç¿’æ…£ã‚’æ•™ãˆã¦ãã ã•ã„",options:[
    {icon:"ğŸ›‹ï¸",label:"ã»ã¨ã‚“ã©é‹å‹•ã—ãªã„",score:1},{icon:"ğŸš¶",label:"é€±1ã€œ2å›ã€æ•£æ­©ã‚„ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ã™ã‚‹",score:2},
    {icon:"ğŸƒ",label:"é€±3å›ä»¥ä¸Šã€ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚„ç­‹ãƒˆãƒ¬ã‚’ã™ã‚‹",score:3},{icon:"ğŸ’ª",label:"æ¯æ—¥ãƒãƒ¼ãƒ‰ãªé‹å‹•ã‚’ã—ã¦ã„ã‚‹",score:4}]},
  {id:"weekend",text:"é€±æœ«ã¯ã©ã®ã‚ˆã†ã«éã”ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ“º",label:"å®¶ã§ã‚†ã£ãã‚Šéã”ã™",score:1},{icon:"ğŸ›ï¸",label:"è²·ã„ç‰©ã‚„è¡—æ­©ãã«å‡ºã‹ã‘ã‚‹",score:2},
    {icon:"ğŸŒ³",label:"å…¬åœ’ã‚„è‡ªç„¶ã®ä¸­ã§éã”ã™",score:3},{icon:"ğŸ§—",label:"ç™»å±±ãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãªã©ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«éã”ã™",score:4}]},
  {id:"stamina",text:"éšæ®µã®ä¸Šã‚Šä¸‹ã‚Šã«ã¤ã„ã¦ã©ã†æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ˜µ",label:"3éšåˆ†ã§ã‚‚ã‹ãªã‚Šãã¤ã„",score:1},{icon:"ğŸ˜…",label:"5éšåˆ†ãã‚‰ã„ãªã‚‰ä½•ã¨ã‹å¤§ä¸ˆå¤«",score:2},
    {icon:"ğŸ˜Š",label:"10éšåˆ†ãã‚‰ã„ã¯ä½™è£•",score:3},{icon:"ğŸ˜¤",label:"ä½•éšã§ã‚‚ã¾ã£ãŸãè‹¦ã«ãªã‚‰ãªã„",score:4}]},
  {id:"hiking_exp",text:"ç™»å±±ã‚„ãƒã‚¤ã‚­ãƒ³ã‚°ã®çµŒé¨“ã¯ã©ã®ãã‚‰ã„ã§ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ”°",label:"ã¾ã£ãŸãã®æœªçµŒé¨“",score:1},{icon:"ğŸ‘Ÿ",label:"ãƒã‚¤ã‚­ãƒ³ã‚°ç¨‹åº¦ãªã‚‰æ•°å›ã‚ã‚‹",score:2},
    {icon:"ğŸ¥¾",label:"æ—¥å¸°ã‚Šç™»å±±ã‚’ä½•åº¦ã‚‚çµŒé¨“ã—ã¦ã„ã‚‹",score:3},{icon:"â›°ï¸",label:"å±±å°å±‹æ³Šãƒ»ç¸¦èµ°ãªã©æœ¬æ ¼çš„ãªçµŒé¨“ãŒè±Šå¯Œ",score:4}]},
  {id:"duration",text:"1å›ã®å±±è¡Œã«ã‹ã‘ã‚‰ã‚Œã‚‹æ™‚é–“ã¯ï¼Ÿ",options:[
    {icon:"â°",label:"2ã€œ3æ™‚é–“ãŒé™åº¦",score:1},{icon:"ğŸ•",label:"åŠæ—¥ï¼ˆ4ã€œ5æ™‚é–“ï¼‰ãã‚‰ã„",score:2},
    {icon:"ğŸŒ…",label:"ä¸¸ä¸€æ—¥ï¼ˆ6ã€œ8æ™‚é–“ï¼‰ã‹ã‘ã¦OK",score:3},{icon:"ğŸ•ï¸",label:"æ³Šã¾ã‚ŠãŒã‘ã§ã‚‚OK",score:4}]},
  {id:"preference",text:"å±±ã«æ±‚ã‚ã‚‹é­…åŠ›ã§ä¸€ç•ªè¿‘ã„ã®ã¯ï¼Ÿ",options:[
    {icon:"ğŸŒ¸",label:"èŠ±ã‚„æ¤ç‰©ã€ç©ã‚„ã‹ãªè‡ªç„¶ã‚’æ¥½ã—ã¿ãŸã„",score:1},{icon:"ğŸ“¸",label:"çµ¶æ™¯ã®å†™çœŸã‚’æ’®ã‚ŠãŸã„ãƒ»SNSæ˜ ãˆ",score:2},
    {icon:"ğŸ—»",label:"é ‚ä¸Šã«ç«‹ã¤é”æˆæ„Ÿã‚’å‘³ã‚ã„ãŸã„",score:3},{icon:"ğŸ§­",label:"äººã®å°‘ãªã„é™ã‹ãªå±±åŸŸã‚’æ­©ããŸã„",score:4}]},
  {id:"risk",text:"å²©å ´ã‚„é–å ´ã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ™…",label:"çµ¶å¯¾ã«é¿ã‘ãŸã„",score:1},{icon:"ğŸ¤”",label:"å°‘ã—ãªã‚‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ãŸã„",score:2},
    {icon:"ğŸ™‚",label:"ã‚ã‚‹ç¨‹åº¦ã®å²©å ´ãªã‚‰æ¥½ã—ã‚ã‚‹",score:3},{icon:"ğŸ¤©",label:"ã‚¬ãƒ³ã‚¬ãƒ³æ”»ã‚ãŸã„ã€ã‚€ã—ã‚å¥½ã",score:4}]},
];

// ============ STATE ============
let selectedPref="",selectedRegion="";
let curQ=0,totalScore=0,answers={};
let mainMap=null,markerLayer=null;
let courseMarkerMap=new Map();
let allCoursesCache=null;
let activeFilters={equipment:"all",duration:"all"};
let searchKeyword="";
let searchDebounceTimer=null;
let sidebarState="landing";

// ============ EQUIPMENT & DURATION MAPPING ============
const EQUIPMENT_MAP={"æ•£ç­–":"casual","å…¥é–€":"casual","åˆç´š":"hiking","ä¸­ç´š":"hiking","ä¸­ç´šã€œä¸Šç´š":"hiking","ä¸Šç´š":"hiking","ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ":"hiking"};
const EQ_LABELS={casual:"ç§æœOK",hiking:"ç™»å±±è£…å‚™"};
const CAT_COLORS={popular:"#2d6a4f",niche:"#7b1fa2",stroll:"#00796b"};

function getEquipmentCategory(diff){return EQUIPMENT_MAP[diff]||"hiking";}

function parseDurationHours(t){
  if(!t||t==="â€”") return null;
  if(/æ³Š/.test(t)) return Infinity;
  let m;
  if((m=t.match(/(\d+(?:\.\d+)?)[ã€œ~\-](\d+(?:\.\d+)?)æ™‚é–“/))) return(parseFloat(m[1])+parseFloat(m[2]))/2;
  if((m=t.match(/(\d+(?:\.\d+)?)æ™‚é–“/))) return parseFloat(m[1]);
  if((m=t.match(/(\d+)åˆ†[ã€œ~\-](\d+(?:\.\d+)?)æ™‚é–“/))) return(parseInt(m[1])/60+parseFloat(m[2]))/2;
  if((m=t.match(/(\d+)åˆ†/))) return parseInt(m[1])/60;
  return null;
}

function getDurationCategory(t){
  const h=parseDurationHours(t);
  if(h===null) return "unknown";
  if(h===Infinity) return "overnight";
  if(h<=1) return "under1h";
  if(h<=3) return "1to3h";
  if(h<=5) return "3to5h";
  return "halfday";
}

// ============ TILE LAYERS ============
const TILE_LAYERS={
  terrain:{url:'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',opts:{attribution:'&copy; <a href="https://opentopomap.org">OpenTopoMap</a>',maxZoom:17}},
  standard:{url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',opts:{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:19}},
  satellite:{url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',opts:{attribution:'&copy; Esri',maxZoom:18}}
};

function addLayerControl(map){
  const C=L.Control.extend({
    options:{position:'topleft'},
    onAdd:function(){
      const d=L.DomUtil.create('div','gmap-layer-ctrl');
      d.innerHTML='<button class="gmap-layer-btn" data-layer="terrain">ğŸ—» åœ°å½¢</button><button class="gmap-layer-btn" data-layer="standard">ğŸ—ºï¸ åœ°å›³</button><button class="gmap-layer-btn active" data-layer="satellite">ğŸ›°ï¸ è¡›æ˜Ÿ</button>';
      L.DomEvent.disableClickPropagation(d);L.DomEvent.disableScrollPropagation(d);
      let cur=L.tileLayer(TILE_LAYERS.satellite.url,TILE_LAYERS.satellite.opts).addTo(map);
      d.addEventListener('click',e=>{
        const b=e.target.closest('.gmap-layer-btn');if(!b)return;
        const k=b.dataset.layer;if(!TILE_LAYERS[k])return;
        d.querySelectorAll('.gmap-layer-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');
        map.removeLayer(cur);cur=L.tileLayer(TILE_LAYERS[k].url,TILE_LAYERS[k].opts).addTo(map);cur.bringToBack();
      });
      return d;
    }
  });
  new C().addTo(map);
}

function addLegendControl(map){
  const C=L.Control.extend({
    options:{position:'bottomleft'},
    onAdd:function(){
      const d=L.DomUtil.create('div','map-legend-ctrl');
      d.innerHTML='<div class="ld"><span class="ldot" style="background:#2d6a4f"></span>å®šç•ª</div><div class="ld"><span class="ldot" style="background:#7b1fa2"></span>ç©´å ´</div><div class="ld"><span class="ldot" style="background:#00796b"></span>æ•£ç­–è·¯</div><div class="ld" style="margin-left:4px"><span style="font-size:13px">ğŸ”¥</span>æ—¬</div>';
      L.DomEvent.disableClickPropagation(d);
      return d;
    }
  });
  new C().addTo(map);
}

// ============ DIFF KEY MAP (for getAllCourses) ============
const DIFF_KEY_MAP={"å…¥é–€":"entry","åˆç´š":"beginner","ä¸­ç´š":"intermediate","ä¸Šç´š":"advanced","ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ":"expert","ä¸­ç´šã€œä¸Šç´š":"intermediate_advanced","æ•£ç­–":"stroll"};

// ============ getAllCourses ============
function getAllCourses(){
  if(allCoursesCache) return allCoursesCache;
  const all=[],seen=new Set();
  for(const[rk,rv] of Object.entries(mountainDB)){
    for(const lv of["entry","beginner","intermediate","advanced","expert"]){
      const d=rv[lv];if(!d) continue;
      (d.popular||[]).forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);all.push({...c,_category:c.niche?"niche":"popular",_level:lv});}});
      (d.niche||[]).forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);all.push({...c,_category:"niche",_level:lv});}});
    }
  }
  for(const[pref,courses] of Object.entries(prefStrollDB)){
    courses.forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);all.push({...c,pref:pref,_category:"stroll",_level:"stroll"});}});
  }
  allCoursesCache=all;
  return all;
}

// ============ INIT ============
function initApp(){
  initMainMap();
  applyFilters();
  setupMobile();
  window.addEventListener('resize',()=>{if(mainMap)mainMap.invalidateSize();});
}

function initMainMap(){
  mainMap=L.map('main-map',{zoomControl:false}).setView([36.2,138.25],5);
  L.control.zoom({position:'bottomright'}).addTo(mainMap);
  addLayerControl(mainMap);
  addLegendControl(mainMap);
  markerLayer=L.layerGroup().addTo(mainMap);
}

// ============ SEARCH ============
function matchesSearch(course,keyword){
  if(!keyword) return true;
  const tokens=keyword.toLowerCase().split(/\s+/).filter(t=>t);
  if(tokens.length===0) return true;
  let searchable=(course.name||'').toLowerCase();
  searchable+=' '+(course.description||'').toLowerCase();
  if(course.pref) searchable+=' '+(Array.isArray(course.pref)?course.pref.join(' '):course.pref).toLowerCase();
  if(course.tags) searchable+=' '+course.tags.map(t=>t.t).join(' ').toLowerCase();
  const hl=COURSE_HIGHLIGHTS[course.name];
  if(hl) searchable+=' '+Object.values(hl).join(' ').toLowerCase();
  return tokens.every(token=>searchable.includes(token));
}

function onSearchInput(value){
  clearTimeout(searchDebounceTimer);
  const clearBtn=document.getElementById('search-clear');
  if(clearBtn) clearBtn.classList.toggle('hidden',!value);
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  searchDebounceTimer=setTimeout(()=>{
    searchKeyword=value.trim();
    applyFilters();
  },300);
}

function clearSearch(){
  const input=document.getElementById('search-input');
  if(input) input.value='';
  const clearBtn=document.getElementById('search-clear');
  if(clearBtn) clearBtn.classList.add('hidden');
  searchKeyword='';
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  applyFilters();
}

function applyPreset(btn,keyword){
  const wasActive=btn.classList.contains('active');
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  const input=document.getElementById('search-input');
  const clearBtn=document.getElementById('search-clear');
  if(wasActive){
    if(input) input.value='';
    if(clearBtn) clearBtn.classList.add('hidden');
    searchKeyword='';
  } else {
    btn.classList.add('active');
    if(input) input.value=keyword;
    if(clearBtn) clearBtn.classList.remove('hidden');
    searchKeyword=keyword;
  }
  applyFilters();
}

// ============ FILTERS ============
function handleFilter(btn,group){
  btn.parentElement.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  activeFilters[group]=btn.dataset.val;
  applyFilters();
}

function applyFilters(){
  if(!markerLayer)return;
  markerLayer.clearLayers();
  courseMarkerMap.clear();
  const courses=getAllCourses();
  const{equipment,duration}=activeFilters;
  let filtered=[];
  courses.forEach(c=>{
    if(equipment!=="all"&&getEquipmentCategory(c.difficulty)!==equipment) return;
    if(duration!=="all"&&getDurationCategory(c.time)!==duration) return;
    if(searchKeyword&&!matchesSearch(c,searchKeyword)) return;
    filtered.push(c);
    const loc=getCourseLocation(c);if(!loc)return;
    const color=CAT_COLORS[c._category]||"#2d6a4f";
    const marker=createMarker(c,color);
    markerLayer.addLayer(marker);
    courseMarkerMap.set(c.name,marker);
  });
  document.getElementById('filter-count').textContent=`${filtered.length} ã‚³ãƒ¼ã‚¹è¡¨ç¤ºä¸­`;
  renderCourseList(filtered);
}

function createMarker(c,color){
  const loc=getCourseLocation(c);
  const ss=getSeasonScore(c);
  const isSeason=ss>=2;
  const sz=isSeason?18:12;
  const seasonLabel=ss===3?(getHighlightText(c)||'ğŸ”¥ä»ŠãŒæ—¬'):ss===2?'âœ¨ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³':'';
  const icon=L.divIcon({className:'',
    html:isSeason
      ?`<div class="marker-season" style="position:relative;width:${sz}px;height:${sz}px"><div class="marker-dot" style="background:${color};width:${sz}px;height:${sz}px"></div><div class="marker-season-label">${seasonLabel}</div></div>`
      :`<div class="marker-dot" style="background:${color};width:${sz}px;height:${sz}px;opacity:${ss===1?0.85:0.5}"></div>`,
    iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
  const catLabel=c._category==="niche"?"ç©´å ´":c._category==="stroll"?"æ•£ç­–è·¯":"å®šç•ª";
  const sl=ss===3?'ğŸ”¥ ä»ŠãŒæ—¬ï¼':ss===2?'âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³':ss===1?'âœ… ä»ŠæœˆOK':'â¸ï¸ ã‚·ãƒ¼ã‚ºãƒ³å¤–';
  const reason=seasonReason(c,ss);
  const prefStr=Array.isArray(c.pref)?c.pref.join('ãƒ»'):c.pref;
  const searchUrl=`https://www.google.com/search?q=${encodeURIComponent(c.name)}`;
  const desc=c.description||'';
  const popup=`<div class="map-popup-title">${course_season_icon(ss)} ${c.name}</div>
    <div class="map-popup-meta">${catLabel}ãƒ»${c.difficulty}<br>ğŸ“ ${prefStr}<br>â±ï¸ ${c.time}ãƒ»ğŸ“ ${c.elevation}<br>ğŸ“… ${c.season}</div>
    ${desc?`<div style="font-size:11px;color:#444;line-height:1.5;margin-top:4px;border-top:1px solid #eee;padding-top:4px">ğŸ“ ${desc}</div>`:''}
    <div class="map-popup-season">${sl}${reason}</div>
    <a href="${searchUrl}" target="_blank" rel="noopener" style="display:inline-block;margin-top:6px;padding:5px 12px;background:#1a73e8;color:#fff;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none">ğŸ” è©³ç´°ã‚’èª¿ã¹ã‚‹</a>`;
  const marker=L.marker([loc.lat,loc.lng],{icon,zIndexOffset:isSeason?1000:0}).bindPopup(popup,{maxWidth:260});
  marker.on('popupopen',()=>highlightCard(c.name));
  marker.on('popupclose',()=>unhighlightCard(c.name));
  return marker;
}

function course_season_icon(ss){return ss===3?'ğŸ”¥':ss===2?'âœ¨':ss===1?'âœ…':'â¸ï¸';}

function seasonReason(c,ss){
  if(ss===3){const hl=getHighlightText(c);return hl?`<br><span style="color:#e65100;font-weight:600">ğŸ’¡ ${hl}</span>`:''}
  if(ss===2) return `<br><span style="color:#2e7d32;font-weight:600">ğŸ’¡ ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆ${c.season}ï¼‰ã®è¦‹é ƒæ™‚æœŸã§ã™</span>`;
  return '';
}

// ============ COURSE LIST ============
function getSearchMatchInfo(course){
  if(!searchKeyword) return '';
  const tokens=searchKeyword.toLowerCase().split(/\s+/).filter(t=>t);
  if(!tokens.length) return '';
  const hl=COURSE_HIGHLIGHTS[course.name];
  if(hl){
    const matched=Object.entries(hl)
      .filter(([m,txt])=>tokens.some(t=>txt.toLowerCase().includes(t)))
      .map(([m,txt])=>`${MONTH_NAMES[parseInt(m)]||m+'æœˆ'}: ${txt}`);
    if(matched.length) return `<div class="sb-ccard-match">ğŸ” ${matched.slice(0,2).join(' / ')}</div>`;
  }
  if(course.description){
    const d=course.description.toLowerCase();
    if(tokens.some(t=>d.includes(t))){
      const snip=course.description.length>40?course.description.slice(0,40)+'â€¦':course.description;
      return `<div class="sb-ccard-match">ğŸ” ${snip}</div>`;
    }
  }
  return '';
}

function renderCourseList(courses){
  const el=document.getElementById('sb-course-list');if(!el)return;
  courses.sort((a,b)=>getSeasonScore(b)-getSeasonScore(a));
  const show=courses.slice(0,80);
  el.innerHTML=show.map(c=>{
    const ss=getSeasonScore(c);
    const eq=getEquipmentCategory(c.difficulty);
    const eqL=EQ_LABELS[eq]||'';
    const color=CAT_COLORS[c._category]||'#2d6a4f';
    const nm=c.name.replace(/'/g,"\\'");
    const desc=c.description?c.description.length>50?c.description.slice(0,50)+'â€¦':c.description:'';
    const matchInfo=getSearchMatchInfo(c);
    return `<div class="sb-ccard" data-course="${c.name}" onclick="panToMarker('${nm}')">
      <div class="sb-ccard-h" style="background:${color}">
        <h4>${course_season_icon(ss)} ${c.name}</h4>
        <span class="eq-tag">${eqL}</span>
      </div>
      <div class="sb-ccard-b">
        <span>â±ï¸ ${c.time}</span><span>ğŸ“ ${c.elevation}</span><span>ğŸ“… ${c.season}</span>
      </div>
      ${desc&&!matchInfo?`<div class="sb-ccard-desc">ğŸ“ ${desc}</div>`:''}
      ${matchInfo}
    </div>`;
  }).join('');
  if(courses.length>80) el.innerHTML+=`<div class="sb-more">åœ°å›³ã‚’æ‹¡å¤§ã™ã‚‹ã¨æ›´ã«ã‚³ãƒ¼ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>`;
}

function panToMarker(name){
  const m=courseMarkerMap.get(name);
  if(m&&mainMap){mainMap.setView(m.getLatLng(),12,{animate:true});setTimeout(()=>m.openPopup(),300);}
}
function highlightCard(name){
  document.querySelectorAll('.sb-ccard').forEach(el=>el.classList.toggle('highlighted',el.dataset.course===name));
  const card=document.querySelector(`.sb-ccard[data-course="${CSS.escape(name)}"]`);
  if(card) card.scrollIntoView({behavior:'smooth',block:'nearest'});
}
function unhighlightCard(name){
  const card=document.querySelector(`.sb-ccard[data-course="${CSS.escape(name)}"]`);
  if(card) card.classList.remove('highlighted');
}

// ============ SIDEBAR VIEW SWITCHING ============
function switchSidebarView(id){
  document.querySelectorAll('.sb-view').forEach(v=>v.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  sidebarState=id.replace('sb-','');
  document.getElementById('sidebar-body').scrollTop=0;
  if(window.innerWidth<=768) expandSidebar();
  updateFab();
}

function backToLanding(){
  switchSidebarView('sb-landing');
  applyFilters();
  mainMap.setView([36.2,138.25],5,{animate:true});
}

// ============ SIDEBAR TOGGLE (PC) ============
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ro=document.getElementById('sidebar-reopen');
  sb.classList.toggle('collapsed');
  ro.style.display=sb.classList.contains('collapsed')?'block':'none';
  setTimeout(()=>{if(mainMap)mainMap.invalidateSize();},350);
}

// ============ MOBILE ============
function setupMobile(){
  const handle=document.getElementById('drag-handle');
  const sb=document.getElementById('sidebar');
  if(!handle) return;
  let startY=0,startT=0;
  handle.addEventListener('touchstart',e=>{
    startY=e.touches[0].clientY;
    const st=getComputedStyle(sb).transform;
    const mx=new DOMMatrix(st);startT=mx.m42||0;
    sb.style.transition='none';
  });
  handle.addEventListener('touchmove',e=>{
    const dy=e.touches[0].clientY-startY;
    const ny=Math.max(0,startT+dy);
    sb.style.transform=`translateY(${ny}px)`;
  });
  handle.addEventListener('touchend',()=>{
    sb.style.transition='transform .3s ease';
    const rect=sb.getBoundingClientRect();
    if(rect.top>window.innerHeight*0.5) collapseSidebar(); else expandSidebar();
  });
}
function collapseSidebar(){
  const sb=document.getElementById('sidebar');
  sb.classList.add('collapsed');sb.style.transform='';
  updateFab();
  setTimeout(()=>{if(mainMap)mainMap.invalidateSize();},350);
}
function expandSidebar(){
  const sb=document.getElementById('sidebar');
  sb.classList.remove('collapsed');sb.style.transform='';
  updateFab();
  setTimeout(()=>{if(mainMap)mainMap.invalidateSize();},350);
}
function updateFab(){
  const fab=document.getElementById('mobile-fab');if(!fab)return;
  const sb=document.getElementById('sidebar');
  fab.classList.toggle('hidden',!(window.innerWidth<=768&&sb.classList.contains('collapsed')&&sidebarState==='landing'));
}

// ============ DIAGNOSIS FLOW ============
function startQuiz(){
  switchSidebarView('sb-pref');
  renderPrefSelector();
}

function renderPrefSelector(){
  const el=document.getElementById("sb-pref");
  let html=`<button class="sb-back" onclick="backToLanding()">â† æˆ»ã‚‹</button>
    <div class="pref-sec"><span class="q-num">STEP 1</span>
    <p class="q-txt">ãŠä½ã¾ã„ã®éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„</p>`;
  for(const[key,r] of Object.entries(REGIONS)){
    html+=`<div class="pref-region"><div class="pref-region-name">${r.name}</div><div class="pref-grid">`;
    r.prefs.forEach(p=>{html+=`<button class="pref-btn" onclick="selectPref(this,'${p}','${key}')">${p.replace(/çœŒ|åºœ|éƒ½/,"")}</button>`;});
    html+=`</div></div>`;
  }
  html+=`</div>`;
  el.innerHTML=html;
}

function selectPref(btn,pref,region){
  document.querySelectorAll(".pref-btn").forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedPref=pref;selectedRegion=region;
  setTimeout(()=>{
    switchSidebarView('sb-quiz');
    curQ=0;totalScore=0;answers={};
    renderQ();
  },300);
}

function renderQ(){
  const q=questions[curQ],total=questions.length;
  const pct=Math.round((curQ/total)*100);
  document.getElementById("p-txt").textContent=`è³ªå• ${curQ+1} / ${total}`;
  document.getElementById("p-pct").textContent=pct+"%";
  document.getElementById("p-fill").style.width=pct+"%";
  document.getElementById("q-box").innerHTML=`
    <div style="animation:fadeIn .25s ease">
      <span class="q-num">Q${curQ+1}</span>
      <p class="q-txt">${q.text}</p>
      <div class="opts">${q.options.map(o=>`
        <button class="opt-btn" onclick="answer('${q.id}',${o.score})">
          <span class="oi">${o.icon}</span><span class="ol">${o.label}</span>
        </button>`).join("")}
      </div>
    </div>`;
}

function answer(id,score){
  answers[id]=score;totalScore+=score;curQ++;
  if(curQ<questions.length) renderQ(); else showDiagnosisResult();
}

function getLevel(s){
  if(s<=10) return "entry";if(s<=14) return "beginner";if(s<=19) return "intermediate";if(s<=24) return "advanced";return "expert";
}

// ============ PREF / NEARBY LOGIC ============
function matchPref(course,pref){
  if(Array.isArray(course.pref)) return course.pref.includes(pref);
  return course.pref===pref;
}
function dedup(arr){const seen=new Set();return arr.filter(c=>{if(seen.has(c.name))return false;seen.add(c.name);return true;});}

function getNearbyPrefExtras(pref,level){
  const adjPrefs=PREF_ADJACENT[pref]||[];
  let extras=[];
  adjPrefs.forEach(ap=>{
    for(const[rk,rv] of Object.entries(mountainDB)){
      const d=rv[level];if(!d) continue;
      const all=[...(d.popular||[]),...(d.niche||[])].filter(c=>matchPref(c,ap));
      if(all.length>0){const pick=all[Math.floor(Math.random()*all.length)];extras.push({...pick,_fromPref:ap});}
    }
  });
  adjPrefs.forEach(ap=>{
    const s=prefStrollDB[ap]||[];
    if(s.length>0){const pick=s[Math.floor(Math.random()*s.length)];extras.push({...pick,_fromPref:ap});}
  });
  return dedup(extras).slice(0,6);
}

// ============ RESULT ============
function renderCard(c,color){
  const isStroll=c.difficulty==="æ•£ç­–";
  const headerColor=isStroll?"linear-gradient(135deg,#00796b,#26a69a)":color;
  const badge=c.niche?'<span class="niche-b">ç©´å ´</span>':isStroll?'<span class="stroll-b">æ•£ç­–è·¯</span>':'';
  const ss=getSeasonScore(c);
  const hl=getHighlightText(c);
  let siHtml='';
  if(ss===3) siHtml=`<div class="season-indicator"><span class="si-badge si-highlight">ğŸ”¥ ä»ŠãŒæ—¬ï¼</span><span class="highlight-text">${hl}</span></div>`;
  else if(ss===2) siHtml=`<div class="season-indicator"><span class="si-badge si-best">âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³</span></div>`;
  else if(ss===1) siHtml=`<div class="season-indicator"><span class="si-badge si-ok">âœ… ä»ŠæœˆOK</span></div>`;
  else siHtml=`<div class="season-indicator"><span class="si-badge si-offseason">â¸ï¸ ã‚·ãƒ¼ã‚ºãƒ³å¤–</span></div>`;
  return `<div class="card" style="${ss===0?'opacity:.6':''}">
    <div class="card-h" style="background:${headerColor}">
      <h3>${c.name}${badge}${ss===3?'<span class="now-tag">NOW</span>':''}</h3>
      <span class="diff-tag">${c.difficulty}</span>
    </div>
    <div class="card-b">
      ${siHtml}
      <div class="c-meta"><span>â±ï¸ ${c.time}</span><span>ğŸ“ ${c.elevation}</span><span>ğŸ“… ${c.season}</span></div>
      <div class="c-tags">${c.tags.map(t=>`<span class="tag ${t.c}">${t.t}</span>`).join("")}</div>
      <p class="c-desc">${c.description}</p>
      <div class="c-tips"><strong>ğŸ’¡ ãƒ„ã‚¦æƒ…å ±ï¼š</strong>${c.tips}</div>
    </div>
  </div>`;
}

function buildSeasonPanel(region,level){
  const m=getCurrentMonth();const s=getSeason(m);const sl=getSeasonLabel(m);
  const advice=SEASONAL_ADVICE[region]&&SEASONAL_ADVICE[region][m];if(!advice) return '';
  const bgClass={spring:"spring-bg",summer:"summer-bg",autumn:"autumn-bg",winter:"winter-bg"}[s];
  const lvWarn=LEVEL_SEASON_WARNINGS[level]&&LEVEL_SEASON_WARNINGS[level][s];
  return `<div class="season-panel">
    <div class="season-header ${bgClass}"><span class="s-icon">${advice.icon}</span>
      <div><div class="s-title">${MONTH_NAMES[m]}ï¼ˆ${sl}ï¼‰ã®${selectedPref}ã‚¨ãƒªã‚¢</div>
      <div class="s-month">ä»Šã®æ™‚æœŸã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼†ãŠã™ã™ã‚</div></div>
    </div>
    <div class="season-body">
      <div class="season-summary">${advice.summary}</div>
      <div class="season-warn"><strong>âš ï¸ æ³¨æ„ï¼š</strong>${advice.warn}</div>
      <div class="season-recommend"><strong>ğŸŒŸ ä»Šæœˆã®ãŠã™ã™ã‚ï¼š</strong>${advice.recommend}</div>
      ${lvWarn?`<div class="level-season-note"><strong>ğŸ“‹ ${LEVEL_META[level].level}ãƒ¬ãƒ™ãƒ«ã®æ–¹ã¸ï¼š</strong>${lvWarn}</div>`:''}
    </div>
  </div>`;
}

function showDiagnosisResult(){
  switchSidebarView('sb-result');
  const level=getLevel(totalScore);
  const meta=LEVEL_META[level];
  const color=LEVEL_COLORS[level];

  let pop=[],niche=[];
  for(const[rk,rv] of Object.entries(mountainDB)){
    const d=rv[level];if(!d) continue;
    pop.push(...(d.popular||[]).filter(c=>matchPref(c,selectedPref)));
    niche.push(...(d.niche||[]).filter(c=>matchPref(c,selectedPref)));
  }
  pop=dedup(pop);niche=dedup(niche);
  const strolls=prefStrollDB[selectedPref]||[];
  const nearby=getNearbyPrefExtras(selectedPref,level);

  const allLocal=[...pop,...niche,...strolls];
  const nowPicks=allLocal.filter(c=>getSeasonScore(c)>=2).sort((a,b)=>getSeasonScore(b)-getSeasonScore(a));
  const seasonPanel=buildSeasonPanel(selectedRegion,level);
  const nearbyPrefs=[...new Set(nearby.map(c=>c._fromPref))];
  const hasMountain=pop.length+niche.length>0;

  let html=`<div class="r-sec">
    <button class="sb-back" onclick="backToLanding()">â† ã‚³ãƒ¼ã‚¹åœ°å›³ã«æˆ»ã‚‹</button>
    <span class="r-badge lv-${level}">ğŸ¯ ã‚ãªãŸã¯ã€Œ${meta.level}ã€ãƒ¬ãƒ™ãƒ«</span>
    <div class="r-region">ğŸ“ ${selectedPref} ã®ãŠã™ã™ã‚</div>
    <div class="r-sum"><p>${meta.message}</p></div>
    ${seasonPanel}
    ${!hasMountain?`<div class="stroll-note" style="background:#e3f2fd;color:#1565c0"><strong>â„¹ï¸ ${selectedPref}ã«ã¯æ²è¼‰ä¸­ã®ç™»å±±ã‚³ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong>æ•£ç­–è·¯ã¨è¿‘éš£çœŒã®ã‚³ãƒ¼ã‚¹ã‚’ã”è¦§ãã ã•ã„ï¼</div>`:''}
    <div class="cards">
      ${nowPicks.length?`<div class="stroll-note" style="background:#fff3e0;color:#e65100"><strong>ğŸ”¥ ${MONTH_NAMES[getCurrentMonth()]}ã«è¡Œããªã‚‰ã“ã“ï¼</strong></div>`:''}
      ${nowPicks.map(c=>renderCard(c,color)).join("")}
      ${pop.filter(c=>getSeasonScore(c)<2).map(c=>renderCard(c,color)).join("")}
      ${niche.filter(c=>getSeasonScore(c)<2).map(c=>renderCard(c,color)).join("")}
      ${strolls.length?`<div class="stroll-note"><strong>ğŸŒ¿ è‡ªç„¶æ•£ç­–è·¯</strong> â€” ç§æœOKãƒ»è¦³å…‰ãƒ—ãƒ©ãƒ³ã«çµ„ã¿è¾¼ã‚ã‚‹ãŠæ‰‹è»½ã‚³ãƒ¼ã‚¹</div>`:''}
      ${strolls.filter(c=>getSeasonScore(c)<2).map(c=>renderCard(c,color)).join("")}
      ${nearby.length?`<div class="nearby-note"><strong>ğŸš— è¿‘éš£çœŒã®ãŠã™ã™ã‚</strong>ï¼ˆ${nearbyPrefs.join("ãƒ»")}ï¼‰</div>`:''}
      ${nearby.map(c=>renderCard(c,color)).join("")}
    </div>
    <button class="btn-restart" onclick="backToLanding()">ğŸ—ºï¸ ã‚³ãƒ¼ã‚¹åœ°å›³ã«æˆ»ã‚‹</button>
    <button class="btn-restart" onclick="startQuiz()">ğŸ“‹ ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
  </div>`;
  document.getElementById('sb-result').innerHTML=html;

  // Update map to show only diagnosis results
  markerLayer.clearLayers();courseMarkerMap.clear();
  const allDiag=[...pop,...niche,...strolls,...nearby];
  allDiag.forEach(c=>{
    const clr=c._fromPref?'#1565c0':(c.difficulty==='æ•£ç­–'?'#00796b':(c.niche?'#7b1fa2':'#2d6a4f'));
    const loc=getCourseLocation(c);if(!loc)return;
    const m=createMarker(c,clr);
    markerLayer.addLayer(m);courseMarkerMap.set(c.name,m);
  });
  const center=PREF_CENTER[selectedPref]||{lat:36.2,lng:138.25};
  const bounds=[];
  markerLayer.eachLayer(m=>{if(m.getLatLng)bounds.push(m.getLatLng());});
  if(bounds.length>0) mainMap.fitBounds(L.latLngBounds(bounds),{padding:[30,30],maxZoom:11});
  else mainMap.setView([center.lat,center.lng],9,{animate:true});
}

// ============ BOOT ============
document.addEventListener('DOMContentLoaded',initApp);
</script>
</body>
</html>
