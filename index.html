<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>å…¨å›½æ•£ç­–ãƒãƒƒãƒ— â€” ãƒã‚¤ã‚­ãƒ³ã‚°ãƒ»ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ã‚³ãƒ¼ã‚¹è¨ºæ–­</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html{height:100%;overflow:hidden}
    body{height:100%;overflow:hidden;font-family:"Hiragino Sans","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;display:flex;background:#eee}
    .hidden{display:none!important}

    /* ========== MAIN MAP ========== */
    #main-map{flex:1;height:100vh;z-index:1}

    /* ========== SIDEBAR (PC) ========== */
    .sidebar{width:380px;height:100vh;background:#fff;display:flex;flex-direction:column;box-shadow:2px 0 12px rgba(0,0,0,.15);z-index:10;flex-shrink:0;transition:margin-left .3s ease;position:relative}
    .sidebar.collapsed{margin-left:-380px}
    .sidebar-header{padding:12px 16px;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;display:flex;align-items:center;gap:10px;flex-shrink:0}
    .sidebar-title{font-size:15px;font-weight:700;flex:1}
    .sidebar-toggle{background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:background .2s}
    .sidebar-toggle:hover{background:rgba(255,255,255,.35)}
    .sidebar-drag{display:none;-webkit-user-select:none;user-select:none}
    .sidebar-body{flex:1;overflow-y:auto;overflow-x:hidden}
    /* sidebar re-open button on map */
    .sidebar-reopen{position:fixed;top:60px;left:12px;z-index:20;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.3);display:none}

    /* ========== SIDEBAR VIEWS ========== */
    .sb-view{padding:16px;animation:fadeIn .25s ease}
    #sb-landing{padding:0}
    .sb-view.hidden{display:none!important}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* ========== LANDING VIEW ========== */
    .sb-hero{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #e8ede8;background:linear-gradient(135deg,#f0faf4,#e8f5e9)}
    .sb-hero-text{flex:1;font-size:11px;color:#555;line-height:1.5}
    .sb-hero-text strong{color:#1b4332;font-size:12px}
    .btn-diag{background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;border:none;padding:7px 14px;border-radius:18px;font-size:12px;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(27,67,50,.25);transition:all .2s;white-space:nowrap;flex-shrink:0}
    .btn-diag:hover{box-shadow:0 3px 12px rgba(27,67,50,.4);transform:translateY(-1px)}

    /* ========== FILTERS ========== */
    .sb-filters{padding:14px 16px;border-bottom:1px solid #e8ede8}
    .filter-group{margin-bottom:10px}
    .filter-group:last-child{margin-bottom:0}
    .filter-label{font-size:11px;font-weight:700;color:#555;display:block;margin-bottom:5px}
    .filter-btns{display:flex;flex-wrap:wrap;gap:5px}
    .fbtn{padding:5px 10px;border:1.5px solid #dce4dc;border-radius:7px;background:#f8faf8;font-size:11px;color:#555;cursor:pointer;transition:all .15s;font-weight:600}
    .fbtn:hover{border-color:#52b788;background:#edf7f0}
    .fbtn.active{border-color:#2d6a4f;background:#2d6a4f;color:#fff}
    .filter-count{font-size:12px;color:#888;padding:8px 16px 0;text-align:right}

    /* ========== SEARCH ========== */
    .sb-search{padding:10px 16px;border-bottom:1px solid #e8ede8}
    .search-box{display:flex;align-items:center;gap:6px;background:#f5f7f5;border:1.5px solid #dce4dc;border-radius:8px;padding:7px 10px;transition:border-color .2s}
    .geo-ctrl{background:#fff;width:40px;height:40px;border-radius:4px;box-shadow:0 1px 5px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;font-size:20px;line-height:1;color:#666;transition:all .2s;padding:0}
    .geo-ctrl:hover{background:#f0f0f0;color:#333}
    .geo-ctrl.geo-active{color:#1565c0}
    .geo-ctrl.geo-active::after{content:'';position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:6px;height:6px;background:#1565c0;border-radius:50%}
    .geo-ctrl.geo-loading{color:#aaa;pointer-events:none}
    .geo-ctrl.geo-error{color:#e53935}
    .geo-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:8px 16px;border-radius:8px;font-size:13px;z-index:10000;pointer-events:none;opacity:0;transition:opacity .3s}
    .geo-toast.show{opacity:1}
    .geo-marker{position:relative;width:20px;height:20px}
    .geo-marker-dot{position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;background:#1565c0;border:3px solid #fff;border-radius:50%;box-shadow:0 0 6px rgba(21,101,192,.6),0 1px 4px rgba(0,0,0,.4);z-index:2}
    .geo-marker-dot.approx{background:#5c6bc0;box-shadow:0 0 6px rgba(92,107,192,.6),0 1px 4px rgba(0,0,0,.4)}
    .geo-marker-pulse{position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;background:rgba(21,101,192,.55);border:2px solid rgba(21,101,192,.4);border-radius:50%;z-index:1;animation:geo-pulse 1.8s ease-out infinite}
    .geo-marker-pulse2{position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;background:rgba(21,101,192,.4);border-radius:50%;z-index:1;animation:geo-pulse 1.8s ease-out .9s infinite}
    .geo-marker-pulse.approx,.geo-marker-pulse2.approx{background:rgba(92,107,192,.45);border-color:rgba(92,107,192,.35)}
    @keyframes geo-pulse{0%{transform:scale(1);opacity:1}70%{opacity:.3}100%{transform:scale(5);opacity:0}}
    .search-box:focus-within{border-color:#2d6a4f;background:#fff}
    .search-icon{font-size:14px;flex-shrink:0}
    #search-input{flex:1;border:none;background:transparent;font-size:13px;outline:none;color:#333;font-family:inherit;min-width:0}
    #search-input::placeholder{color:#aaa}
    .search-clear{background:none;border:none;color:#999;font-size:14px;cursor:pointer;padding:0 2px;flex-shrink:0}
    .search-clear:hover{color:#555}
    .sb-ccard-match{padding:3px 10px 5px;font-size:10px;color:#e65100;background:#fff8f0;border-top:1px solid #ffe0b2}
    .sb-ccard-dist{color:#1565c0;font-weight:600;font-size:11px}

    /* ========== SEARCH PRESETS ========== */
    .sb-presets{padding:12px 16px;border-bottom:1px solid #e8ede8}
    .preset-cat{margin-bottom:10px}
    .preset-cat:last-child{margin-bottom:0}
    .preset-cat-name{font-size:10px;font-weight:700;color:#888;margin-bottom:5px;display:flex;align-items:center;gap:4px}
    .preset-btns{display:flex;flex-wrap:wrap;gap:4px}
    .preset-btn{padding:4px 9px;border:1.5px solid #e8ede8;border-radius:14px;background:#fff;font-size:11px;color:#555;cursor:pointer;transition:all .15s;white-space:nowrap}
    .preset-btn:hover{border-color:#52b788;background:#edf7f0;color:#2d6a4f}
    .preset-btn.active{border-color:#2d6a4f;background:#e8f5e9;color:#1b4332;font-weight:600}

    /* ========== COURSE LIST ========== */
    .sb-course-list{padding:8px 12px}
    .sb-ccard{border:1px solid #e4e8e4;border-radius:10px;overflow:hidden;cursor:pointer;transition:all .15s;margin-bottom:8px}
    .sb-ccard:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);border-color:#52b788}
    .sb-ccard.highlighted{border-color:#2d6a4f;box-shadow:0 0 0 2px rgba(45,106,79,.25)}
    .sb-ccard-h{padding:7px 10px;color:#fff;display:flex;justify-content:space-between;align-items:center}
    .sb-ccard-h h4{font-size:12px;font-weight:700;flex:1;margin-right:6px}
    .sb-ccard-h .eq-tag{font-size:10px;background:rgba(255,255,255,.25);padding:2px 6px;border-radius:4px;white-space:nowrap}
    .sb-ccard-b{padding:6px 10px;font-size:11px;color:#666;display:flex;gap:8px;flex-wrap:wrap}
    .sb-ccard-b span{white-space:nowrap}
    .sb-ccard-desc{padding:4px 10px 7px;font-size:11px;color:#555;line-height:1.5;border-top:1px solid #eee}
    .sb-ccard-bm{background:none;border:none;cursor:pointer;line-height:1;padding:2px 0 2px 4px;flex-shrink:0;transition:transform .15s;-webkit-user-select:none;user-select:none}
    .sb-ccard-bm:active{transform:scale(1.3)}
    .sb-ccard-bm svg{width:16px;height:16px;fill:none;stroke:rgba(255,255,255,.6);stroke-width:2}
    .sb-ccard-bm.saved svg{fill:#7c4dff;stroke:#7c4dff}
    .sb-more{text-align:center;color:#999;font-size:11px;padding:10px}
    /* bookmark toggle tab */
    .sb-bm-bar{padding:8px 16px 0;display:flex;align-items:center;gap:6px}
    .sb-bm-toggle{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;border-radius:18px;border:1.5px solid #e8ede8;background:#fff;font-size:12px;font-weight:600;color:#888;cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none}
    .sb-bm-toggle:hover{border-color:#7c4dff;color:#7c4dff}
    .sb-bm-toggle.active{background:#ede7f6;border-color:#7c4dff;color:#5e35b1}
    @keyframes bm-pulse{0%{box-shadow:0 0 0 0 rgba(124,77,255,.5)}70%{box-shadow:0 0 0 12px rgba(124,77,255,0)}100%{box-shadow:0 0 0 0 rgba(124,77,255,0)}}
    .sb-bm-toggle.pulse{animation:bm-pulse .7s ease-out}
    .sb-bm-count{font-size:10px;background:#7c4dff;color:#fff;border-radius:10px;padding:1px 6px;font-weight:700;min-width:16px;text-align:center}
    .sb-bm-empty{text-align:center;color:#aaa;font-size:13px;padding:30px 16px;line-height:1.7}
    /* popup bookmark button */
    .popup-bm-btn{display:inline-flex;align-items:center;gap:3px;margin-top:6px;margin-left:6px;padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1.5px solid #ddd;background:#fff;color:#555;transition:all .15s;vertical-align:top}
    .popup-bm-btn:hover{border-color:#7c4dff;color:#7c4dff}
    .popup-bm-btn.saved{background:#ede7f6;border-color:#7c4dff;color:#5e35b1}
    .popup-bm-btn svg{width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;flex-shrink:0}
    .popup-bm-btn.saved svg{fill:#7c4dff;stroke:#7c4dff}
    /* bookmarked marker icon */
    .bm-marker-icon{display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 1px 3px rgba(0,0,0,.45))}
    .bm-marker-icon svg{width:22px;height:22px;fill:#7c4dff;stroke:#fff;stroke-width:1.5}

    /* ========== MAP LEGEND (on map) ========== */
    .map-legend-ctrl{display:flex;gap:8px;background:#fff;padding:6px 10px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,.2);font-size:11px;color:#555}
    .map-legend-ctrl .ld{display:flex;align-items:center;gap:3px}
    .map-legend-ctrl .ldot{width:10px;height:10px;border-radius:50%;border:1.5px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.3)}

    /* ========== QUIZ / PREF SELECTOR ========== */
    .sb-back{background:none;border:none;color:#2d6a4f;font-size:13px;font-weight:600;cursor:pointer;padding:0 0 10px;display:inline-block}
    .sb-back:hover{text-decoration:underline}
    .pref-sec{padding:4px 0}
    .q-num{display:inline-block;background:#e8f5e9;color:#2d6a4f;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;margin-bottom:8px}
    .q-txt{font-size:15px;font-weight:700;color:#1b4332;margin-bottom:14px;line-height:1.5}
    .pref-region{margin-bottom:14px}
    .pref-region-name{font-size:12px;font-weight:700;color:#2d6a4f;margin-bottom:6px;padding-left:2px}
    .pref-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:5px}
    .pref-btn{padding:7px 4px;border:1.5px solid #dce4dc;border-radius:8px;background:#f8faf8;font-size:11px;color:#444;cursor:pointer;text-align:center;transition:all .15s;font-weight:600}
    .pref-btn:hover{border-color:#52b788;background:#edf7f0}
    .pref-btn.selected{background:#2d6a4f;color:#fff;border-color:#2d6a4f}

    .prog{margin-bottom:14px}
    .prog-top{display:flex;justify-content:space-between;font-size:11px;color:#777;margin-bottom:4px}
    .prog-bar{height:5px;background:#e8ede8;border-radius:3px;overflow:hidden}
    .prog-fill{height:100%;background:linear-gradient(90deg,#2d6a4f,#52b788);border-radius:3px;transition:width .3s}

    .opts{display:flex;flex-direction:column;gap:7px}
    .opt-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1.5px solid #dce4dc;border-radius:10px;background:#fff;cursor:pointer;transition:all .15s;text-align:left;font-size:13px}
    .opt-btn:hover{border-color:#52b788;background:#edf7f0;transform:translateX(3px)}
    .oi{font-size:20px;flex-shrink:0}
    .ol{flex:1;color:#333}

    /* ========== RESULT VIEW ========== */
    .r-sec{padding:4px 0}
    .r-badge{display:inline-block;font-size:13px;font-weight:700;padding:6px 14px;border-radius:20px;margin-bottom:8px}
    .lv-entry{background:#e8f5e9;color:#388e3c}
    .lv-beginner{background:#e8f5e9;color:#2e7d32}
    .lv-intermediate{background:#fff8e1;color:#f57f17}
    .lv-advanced{background:#fbe9e7;color:#d84315}
    .lv-expert{background:#f3e5f5;color:#6a1b9a}
    .r-region{font-size:14px;font-weight:700;color:#1b4332;margin-bottom:6px}
    .r-sum{font-size:13px;color:#555;line-height:1.6;margin-bottom:12px;padding:10px;background:#f8faf8;border-radius:10px}
    .r-sum p{margin:0}

    .cards{display:flex;flex-direction:column;gap:10px}
    .card{border-radius:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.08);transition:all .2s;border:1px solid #e8ede8;cursor:pointer}
    .card:hover{box-shadow:0 3px 12px rgba(0,0,0,.12)}
    .card-h{padding:10px 14px;color:#fff;display:flex;justify-content:space-between;align-items:center;border-radius:10px 10px 0 0}
    .card-h h3{font-size:14px;font-weight:700;flex:1}
    .diff-tag{font-size:10px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px;white-space:nowrap}
    .niche-b,.stroll-b{font-size:10px;padding:1px 6px;border-radius:4px;margin-left:6px}
    .niche-b{background:rgba(198,40,40,.2);color:#ef9a9a}
    .stroll-b{background:rgba(0,121,107,.2);color:#b2dfdb}
    .now-tag{font-size:9px;background:#ff6f00;color:#fff;padding:2px 6px;border-radius:4px;margin-left:6px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .card-b{padding:12px 14px}
    .c-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:#666;margin-bottom:8px}
    .c-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
    .tag{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
    .tag-highlight{background:#fff3e0;color:#e65100}
    .tag-niche{background:#f3e5f5;color:#7b1fa2}
    .tag-view{background:#e3f2fd;color:#1565c0}
    .tag-nature{background:#e8f5e9;color:#2e7d32}
    .tag-season{background:#fce4ec;color:#c62828}
    .tag-stroll{background:#e0f2f1;color:#00695c}
    .c-desc{font-size:12px;color:#444;line-height:1.6;margin-bottom:8px}
    .c-tips{font-size:11px;color:#666;background:#f8faf8;padding:8px 10px;border-radius:8px;line-height:1.5}

    .season-indicator{margin-bottom:6px}
    .si-badge{display:inline-block;font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px}
    .si-highlight{background:#fff3e0;color:#e65100}
    .si-best{background:#e8f5e9;color:#2e7d32}
    .si-ok{background:#f5f5f5;color:#666}
    .si-offseason{background:#f5f5f5;color:#999}
    .highlight-text{font-size:11px;color:#e65100;margin-left:4px}

    .stroll-note,.nearby-note{font-size:12px;padding:10px;border-radius:8px;margin-bottom:4px}
    .stroll-note{background:#e0f2f1;color:#00695c}
    .nearby-note{background:#e3f2fd;color:#1565c0}

    .season-panel{border-radius:10px;overflow:hidden;margin-bottom:12px;border:1px solid #e0e0e0}
    .season-header{padding:12px 14px;display:flex;align-items:center;gap:10px;color:#fff}
    .spring-bg{background:linear-gradient(135deg,#f48fb1,#f06292)}
    .summer-bg{background:linear-gradient(135deg,#26a69a,#00897b)}
    .autumn-bg{background:linear-gradient(135deg,#ff8a65,#f4511e)}
    .winter-bg{background:linear-gradient(135deg,#64b5f6,#1e88e5)}
    .s-icon{font-size:24px}
    .s-title{font-size:13px;font-weight:700}
    .s-month{font-size:11px;opacity:.85}
    .season-body{padding:12px 14px;font-size:12px;color:#444;line-height:1.6}
    .season-summary{margin-bottom:6px}
    .season-warn{color:#c62828;margin-bottom:6px}
    .season-recommend{color:#2e7d32;margin-bottom:6px}
    .level-season-note{color:#1565c0;background:#e3f2fd;padding:6px 8px;border-radius:6px}

    .btn-restart{display:block;width:100%;padding:10px;border:2px solid #2d6a4f;border-radius:10px;background:#fff;color:#2d6a4f;font-size:13px;font-weight:600;cursor:pointer;margin-top:8px;transition:all .15s}
    .btn-restart:hover{background:#2d6a4f;color:#fff}

    /* ========== MAP CONTROLS (reused) ========== */
    .gmap-layer-ctrl{display:flex;gap:0;border-radius:8px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.2);font-family:"Hiragino Sans","Noto Sans JP",sans-serif}
    .gmap-layer-btn{padding:7px 14px;font-size:12px;font-weight:600;border:none;cursor:pointer;color:#444;background:#fff;transition:background .15s,color .15s;white-space:nowrap}
    .gmap-layer-btn:hover{background:#f0f0f0}
    .gmap-layer-btn.active{background:#e8f5e9;color:#1b4332;border-bottom:2px solid #2d6a4f}
    .map-popup-title{font-size:14px;font-weight:700;color:#1b4332;margin-bottom:4px}
    .map-popup-meta{font-size:12px;color:#666;line-height:1.5}
    .map-popup-season{font-size:11px;margin-top:4px}
    /* season tooltip on circleMarkers */
    .season-tip{background:linear-gradient(135deg,#ff6f00,#ff8f00);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;border:none;box-shadow:0 1px 3px rgba(0,0,0,.3);white-space:nowrap;pointer-events:none;transition:none!important}
    .season-tip::before{border-top-color:#ff8f00}
    .leaflet-zooming .season-tip{opacity:0!important;transition:none!important}
    .leaflet-tooltip{transition:none!important}
    .season-pulse-wrap{pointer-events:none}
    .season-pulse-ring{position:absolute;top:50%;left:50%;width:14px;height:14px;margin:-7px 0 0 -7px;border-radius:50%;background:rgba(255,111,0,.4);animation:season-pulse 2s ease-out infinite}
    .season-pulse-ring.s3{background:rgba(255,61,0,.45)}
    .leaflet-zooming .season-pulse-ring{opacity:0!important;animation:none!important}
    @keyframes season-pulse{0%{transform:scale(1);opacity:.8}100%{transform:scale(3.5);opacity:0}}

    /* ========== MOBILE (bottom sheet) ========== */
    @media(max-width:768px){
      html{height:-webkit-fill-available;height:100dvh;overflow:hidden;position:fixed;inset:0}
      body{height:-webkit-fill-available;height:100dvh;overflow:hidden;flex-direction:column;position:fixed;inset:0}
      #main-map{position:fixed;inset:0;width:100%;height:100%;height:-webkit-fill-available}
      .sidebar,.sidebar.collapsed{position:fixed;bottom:0;left:0;right:0;width:100%;height:90%;border-radius:16px 16px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.2);z-index:100;transition:transform .35s cubic-bezier(.2,.9,.3,1);margin-left:0;overflow:hidden;display:flex;flex-direction:column}
      .sidebar-drag{display:flex;align-items:center;justify-content:center;width:100%;height:44px;flex-shrink:0;cursor:grab;touch-action:none}
      .sidebar-drag::after{content:'';display:block;width:48px;height:5px;background:#aaa;border-radius:3px}
      .sidebar-header{display:none}
      .sidebar-reopen{display:none!important}
      .leaflet-control-zoom{display:none!important}
      .gmap-layer-ctrl{display:none!important}
      .pref-grid{grid-template-columns:repeat(auto-fill,minmax(52px,1fr))}
      .pref-btn{padding:6px 2px;font-size:10px}
      .mobile-fab{display:none!important}
      .sb-presets{display:none!important}
      .leaflet-bottom.leaflet-right{transition:bottom .35s cubic-bezier(.2,.9,.3,1)}
      /* map preset â€” 2-tier: category row + sub-chip row */
      .map-preset-wrap{position:fixed;top:0;left:0;right:0;z-index:99;pointer-events:none;padding-top:calc(env(safe-area-inset-top,0px) + 4px)}
      .map-preset-cats{display:flex;gap:6px;padding:4px 10px;pointer-events:auto;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
      .map-preset-cats::-webkit-scrollbar{display:none}
      .map-preset-cat{flex-shrink:0;padding:7px 13px;border-radius:20px;background:#fff;border:1.5px solid rgba(0,0,0,.08);font-size:13px;font-weight:600;color:#333;cursor:pointer;box-shadow:0 1px 5px rgba(0,0,0,.12);transition:all .15s;user-select:none;-webkit-user-select:none}
      .map-preset-cat:active{transform:scale(.95)}
      .map-preset-cat.open{background:#2d6a4f;color:#fff;border-color:#2d6a4f}
      .map-preset-cat.has-active{background:#1b4332;color:#fff;border-color:#1b4332}
      .map-preset-reset{flex-shrink:0;width:34px;height:34px;border-radius:50%;background:#fff;border:1.5px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 1px 5px rgba(0,0,0,.12);transition:all .15s;user-select:none;pointer-events:auto;color:#888}
      .map-preset-reset:active{transform:scale(.9)}
      .map-preset-reset.show{color:#c62828}
      .map-preset-subs{display:flex;gap:6px;padding:6px 10px 2px;pointer-events:auto;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;max-height:0;opacity:0;transition:max-height .25s ease,opacity .2s ease,padding .25s ease;padding-top:0;padding-bottom:0}
      .map-preset-subs::-webkit-scrollbar{display:none}
      .map-preset-subs.open{max-height:50px;opacity:1;padding-top:6px;padding-bottom:2px}
      .map-preset-sub{flex-shrink:0;padding:6px 12px;border-radius:16px;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border:1.5px solid rgba(0,0,0,.08);font-size:12px;font-weight:500;color:#444;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.1);transition:all .15s;user-select:none;-webkit-user-select:none;white-space:nowrap}
      .map-preset-sub:active{transform:scale(.95)}
      .map-preset-sub.active{background:#1b4332;color:#fff;border-color:#1b4332;box-shadow:0 2px 8px rgba(27,67,50,.35)}
      /* mobile layer toggle */
      .mob-layer-toggle{background:#fff;width:40px;height:40px;border-radius:4px;box-shadow:0 1px 5px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;color:#666;padding:0;position:relative}
      .mob-layer-toggle:hover{background:#f0f0f0}
      .mob-layer-balloon{position:absolute;bottom:48px;right:0;background:#fff;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.25);padding:6px;display:flex;flex-direction:column;gap:4px;opacity:0;pointer-events:none;transform:translateY(8px) scale(.95);transition:all .2s ease}
      .mob-layer-balloon.show{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
      .mob-layer-balloon::after{content:'';position:absolute;bottom:-6px;right:12px;width:12px;height:12px;background:#fff;transform:rotate(45deg);box-shadow:2px 2px 4px rgba(0,0,0,.08)}
      .mob-layer-opt{padding:8px 14px;border:none;border-radius:6px;background:transparent;font-size:12px;font-weight:600;color:#444;cursor:pointer;white-space:nowrap;text-align:left;transition:background .15s}
      .mob-layer-opt:active{background:#f0f0f0}
      .mob-layer-opt.active{background:#e8f5e9;color:#1b4332}
    }
    @media(min-width:769px){
      .map-preset-wrap{display:none!important}
      .mob-layer-toggle{display:none!important}
    }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-drag" id="drag-handle"></div>
  <div class="sidebar-header">
    <span style="font-size:18px">ğŸ—¾</span>
    <span class="sidebar-title">å…¨å›½æ•£ç­–ãƒãƒƒãƒ—</span>
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">â—€</button>
  </div>
  <div class="sidebar-body" id="sidebar-body">

    <!-- LANDING VIEW -->
    <div id="sb-landing" class="sb-view">
      <div class="sb-hero">
        <div class="sb-hero-text"><strong>ã‚ãªãŸã«åˆã†ã‚³ãƒ¼ã‚¹ã¯ï¼Ÿ</strong><br>ä½“åŠ›ãƒ»çµŒé¨“ã‹ã‚‰ãŠã™ã™ã‚ã‚’è¨ºæ–­</div>
        <button class="btn-diag" onclick="startQuiz()">ğŸ“‹ è¨ºæ–­ã™ã‚‹</button>
      </div>
      <div class="sb-search">
        <div class="search-box">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="search-input" placeholder="ã‚³ãƒ¼ã‚¹åãƒ»è¦‹ã©ã“ã‚ã§æ¤œç´¢â€¦" oninput="onSearchInput(this.value)">
          <button class="search-clear hidden" id="search-clear" onclick="clearSearch()">âœ•</button>
        </div>
      </div>
      <div class="sb-bm-bar" id="sb-bm-bar">
        <button class="sb-bm-toggle" id="sb-bm-toggle" onclick="toggleBookmarkView()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg> ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ <span class="sb-bm-count" id="sb-bm-count">0</span></button>
      </div>
      <div class="sb-presets" id="sb-presets">
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸŒ¸ å­£ç¯€ã®èŠ±ãƒ»æ¤ç‰©</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'æ¡œ')">æ¡œ</button>
            <button class="preset-btn" onclick="applyPreset(this,'ç´…è‘‰')">ç´…è‘‰</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ–°ç·‘')">æ–°ç·‘</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ¢…')">æ¢…</button>
            <button class="preset-btn" onclick="applyPreset(this,'ãƒ„ãƒ„ã‚¸')">ãƒ„ãƒ„ã‚¸</button>
            <button class="preset-btn" onclick="applyPreset(this,'ã‚¢ã‚¸ã‚µã‚¤')">ã‚¢ã‚¸ã‚µã‚¤</button>
          </div>
        </div>
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸ”ï¸ è‡ªç„¶ã®è¦‹ã©ã“ã‚</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'æ¸“è°·')">æ¸“è°·</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ»')">æ»</button>
            <button class="preset-btn" onclick="applyPreset(this,'æµ·')">æµ·</button>
            <button class="preset-btn" onclick="applyPreset(this,'å¯Œå£«å±±')">å¯Œå£«å±±</button>
            <button class="preset-btn" onclick="applyPreset(this,'é«˜åŸ')">é«˜åŸ</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ£®æ—æµ´')">æ£®æ—æµ´</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ¹–')">æ¹–</button>
          </div>
        </div>
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸ¯ æ­´å²ãƒ»æ–‡åŒ–</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'ç¥ç¤¾')">ç¥ç¤¾</button>
            <button class="preset-btn" onclick="applyPreset(this,'å¯º')">å¯º</button>
            <button class="preset-btn" onclick="applyPreset(this,'åŸ')">åŸ</button>
            <button class="preset-btn" onclick="applyPreset(this,'æ¸©æ³‰')">æ¸©æ³‰</button>
            <button class="preset-btn" onclick="applyPreset(this,'ä¸–ç•Œéºç”£')">ä¸–ç•Œéºç”£</button>
          </div>
        </div>
        <div class="preset-cat">
          <div class="preset-cat-name">ğŸ¥¾ ã‚³ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ</div>
          <div class="preset-btns">
            <button class="preset-btn" onclick="applyPreset(this,'ã”å½“åœ°ã‚¢ãƒ«ãƒ—ã‚¹')">ã”å½“åœ°ã‚¢ãƒ«ãƒ—ã‚¹</button>
            <button class="preset-btn" onclick="applyPreset(this,'ãƒ­ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«')">ãƒ­ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«</button>
            <button class="preset-btn" onclick="applyPreset(this,'é–¢æ±ãµã‚Œã‚ã„ã®é“')">é–¢æ±ãµã‚Œã‚ã„ã®é“</button>
            <button class="preset-btn" onclick="applyPreset(this,'ç™¾åå±±')">ç™¾åå±±</button>
            <button class="preset-btn" onclick="applyPreset(this,'å±•æœ›')">å±•æœ›</button>
            <button class="preset-btn" onclick="applyPreset(this,'ç¸¦èµ°')">ç¸¦èµ°</button>
          </div>
        </div>
      </div>
      <div class="sb-filters">
        <div class="filter-group">
          <label class="filter-label">è£…å‚™åŸºæº–</label>
          <div class="filter-btns">
            <button class="fbtn active" data-val="all" onclick="handleFilter(this,'equipment')">ã™ã¹ã¦</button>
            <button class="fbtn" data-val="casual" onclick="handleFilter(this,'equipment')">ğŸ‘Ÿ ç§æœã§æ­©ã‘ã‚‹</button>
            <button class="fbtn" data-val="hiking" onclick="handleFilter(this,'equipment')">ğŸ¥¾ ç™»å±±è£…å‚™ãŒå¿…è¦</button>
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">æ‰€è¦æ™‚é–“</label>
          <div class="filter-btns">
            <button class="fbtn active" data-val="all" onclick="handleFilter(this,'duration')">ã™ã¹ã¦</button>
            <button class="fbtn" data-val="under2h" onclick="handleFilter(this,'duration')">ã€œ2æ™‚é–“</button>
            <button class="fbtn" data-val="2to5h" onclick="handleFilter(this,'duration')">2ã€œ5æ™‚é–“</button>
            <button class="fbtn" data-val="halfday" onclick="handleFilter(this,'duration')">åŠæ—¥ä»¥ä¸Š</button>
            <button class="fbtn" data-val="overnight" onclick="handleFilter(this,'duration')">1æ³Šä»¥ä¸Š</button>
          </div>
        </div>
      </div>
      <div class="filter-count" id="filter-count"></div>
      <div class="sb-course-list" id="sb-course-list"></div>
    </div>

    <!-- PREF VIEW -->
    <div id="sb-pref" class="sb-view hidden"></div>

    <!-- QUIZ VIEW -->
    <div id="sb-quiz" class="sb-view hidden">
      <button class="sb-back" onclick="backToLanding()">â† æˆ»ã‚‹</button>
      <div class="prog">
        <div class="prog-top"><span id="p-txt"></span><span id="p-pct"></span></div>
        <div class="prog-bar"><div class="prog-fill" id="p-fill"></div></div>
      </div>
      <div id="q-box"></div>
    </div>

    <!-- RESULT VIEW -->
    <div id="sb-result" class="sb-view hidden"></div>
  </div>
</div>

<!-- SIDEBAR REOPEN (PC only, shown when sidebar collapsed) -->
<button class="sidebar-reopen" id="sidebar-reopen" onclick="toggleSidebar()">â˜° ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

<!-- MAIN MAP -->
<div id="main-map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Leaflet.SmoothWheelZoom plugin (MIT) â€” https://github.com/mutsuyuki/Leaflet.SmoothWheelZoom */
L.Map.mergeOptions({smoothWheelZoom:true,smoothSensitivity:1});
L.Map.SmoothWheelZoom=L.Handler.extend({
  addHooks:function(){L.DomEvent.on(this._map._container,'wheel',this._onWheelScroll,this)},
  removeHooks:function(){L.DomEvent.off(this._map._container,'wheel',this._onWheelScroll,this)},
  _onWheelScroll:function(e){if(!this._isWheeling)this._onWheelStart(e);this._onWheeling(e)},
  _onWheelStart:function(e){
    var map=this._map;this._isWheeling=true;
    this._wheelMousePosition=map.mouseEventToContainerPoint(e);
    this._centerPoint=map.getSize()._divideBy(2);
    this._startLatLng=map.containerPointToLatLng(this._centerPoint);
    this._wheelStartLatLng=map.containerPointToLatLng(this._wheelMousePosition);
    this._startZoom=map.getZoom();this._moved=false;this._zooming=true;
    map._stop();if(map._panAnim)map._panAnim.stop();
    this._goalZoom=map.getZoom();this._prevCenter=map.getCenter();this._prevZoom=map.getZoom();
    this._zoomAnimationId=requestAnimationFrame(this._updateWheelZoom.bind(this));
  },
  _onWheeling:function(e){
    var map=this._map;
    this._goalZoom=this._goalZoom+L.DomEvent.getWheelDelta(e)*0.003*map.options.smoothSensitivity;
    if(this._goalZoom<map.getMinZoom()||this._goalZoom>map.getMaxZoom())this._goalZoom=map._limitZoom(this._goalZoom);
    this._wheelMousePosition=this._map.mouseEventToContainerPoint(e);
    clearTimeout(this._timeoutId);this._timeoutId=setTimeout(this._onWheelEnd.bind(this),200);
    L.DomEvent.preventDefault(e);L.DomEvent.stopPropagation(e);
  },
  _onWheelEnd:function(){this._isWheeling=false;cancelAnimationFrame(this._zoomAnimationId);this._map._moveEnd(true)},
  _updateWheelZoom:function(){
    var map=this._map;
    if(!map.getCenter().equals(this._prevCenter)||map.getZoom()!=this._prevZoom)return;
    this._zoom=map.getZoom()+(this._goalZoom-map.getZoom())*0.3;
    this._zoom=Math.floor(this._zoom*100)/100;
    var delta=this._wheelMousePosition.subtract(this._centerPoint);
    if(delta.x===0&&delta.y===0)return;
    if(map.options.smoothWheelZoom==='center'){this._center=this._startLatLng}
    else{this._center=map.unproject(map.project(this._wheelStartLatLng,this._zoom).subtract(delta),this._zoom)}
    if(!this._moved){map._moveStart(true,false);this._moved=true}
    map._move(this._center,this._zoom);this._prevCenter=map.getCenter();this._prevZoom=map.getZoom();
    this._zoomAnimationId=requestAnimationFrame(this._updateWheelZoom.bind(this));
  }
});
L.Map.addInitHook('addHandler','smoothWheelZoom',L.Map.SmoothWheelZoom);
</script>
<script src="mountains.js?v=20260217u"></script>
<script>
// ============ QUESTIONS ============
const questions=[
  {id:"exercise",text:"æ™®æ®µã®é‹å‹•ç¿’æ…£ã‚’æ•™ãˆã¦ãã ã•ã„",options:[
    {icon:"ğŸ›‹ï¸",label:"ã»ã¨ã‚“ã©é‹å‹•ã—ãªã„",score:1},{icon:"ğŸš¶",label:"é€±1ã€œ2å›ã€æ•£æ­©ã‚„ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ã™ã‚‹",score:2},
    {icon:"ğŸƒ",label:"é€±3å›ä»¥ä¸Šã€ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚„ç­‹ãƒˆãƒ¬ã‚’ã™ã‚‹",score:3},{icon:"ğŸ’ª",label:"æ¯æ—¥ãƒãƒ¼ãƒ‰ãªé‹å‹•ã‚’ã—ã¦ã„ã‚‹",score:4}]},
  {id:"weekend",text:"é€±æœ«ã¯ã©ã®ã‚ˆã†ã«éã”ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ“º",label:"å®¶ã§ã‚†ã£ãã‚Šéã”ã™",score:1},{icon:"ğŸ›ï¸",label:"è²·ã„ç‰©ã‚„è¡—æ­©ãã«å‡ºã‹ã‘ã‚‹",score:2},
    {icon:"ğŸŒ³",label:"å…¬åœ’ã‚„è‡ªç„¶ã®ä¸­ã§éã”ã™",score:3},{icon:"ğŸ§—",label:"ç™»å±±ãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãªã©ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«éã”ã™",score:4}]},
  {id:"stamina",text:"éšæ®µã®ä¸Šã‚Šä¸‹ã‚Šã«ã¤ã„ã¦ã©ã†æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ˜µ",label:"3éšåˆ†ã§ã‚‚ã‹ãªã‚Šãã¤ã„",score:1},{icon:"ğŸ˜…",label:"5éšåˆ†ãã‚‰ã„ãªã‚‰ä½•ã¨ã‹å¤§ä¸ˆå¤«",score:2},
    {icon:"ğŸ˜Š",label:"10éšåˆ†ãã‚‰ã„ã¯ä½™è£•",score:3},{icon:"ğŸ˜¤",label:"ä½•éšã§ã‚‚ã¾ã£ãŸãè‹¦ã«ãªã‚‰ãªã„",score:4}]},
  {id:"hiking_exp",text:"ç™»å±±ã‚„ãƒã‚¤ã‚­ãƒ³ã‚°ã®çµŒé¨“ã¯ã©ã®ãã‚‰ã„ã§ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ”°",label:"ã¾ã£ãŸãã®æœªçµŒé¨“",score:1},{icon:"ğŸ‘Ÿ",label:"ãƒã‚¤ã‚­ãƒ³ã‚°ç¨‹åº¦ãªã‚‰æ•°å›ã‚ã‚‹",score:2},
    {icon:"ğŸ¥¾",label:"æ—¥å¸°ã‚Šç™»å±±ã‚’ä½•åº¦ã‚‚çµŒé¨“ã—ã¦ã„ã‚‹",score:3},{icon:"â›°ï¸",label:"å±±å°å±‹æ³Šãƒ»ç¸¦èµ°ãªã©æœ¬æ ¼çš„ãªçµŒé¨“ãŒè±Šå¯Œ",score:4}]},
  {id:"duration",text:"1å›ã®å±±è¡Œã«ã‹ã‘ã‚‰ã‚Œã‚‹æ™‚é–“ã¯ï¼Ÿ",options:[
    {icon:"â°",label:"2ã€œ3æ™‚é–“ãŒé™åº¦",score:1},{icon:"ğŸ•",label:"åŠæ—¥ï¼ˆ4ã€œ5æ™‚é–“ï¼‰ãã‚‰ã„",score:2},
    {icon:"ğŸŒ…",label:"ä¸¸ä¸€æ—¥ï¼ˆ6ã€œ8æ™‚é–“ï¼‰ã‹ã‘ã¦OK",score:3},{icon:"ğŸ•ï¸",label:"æ³Šã¾ã‚ŠãŒã‘ã§ã‚‚OK",score:4}]},
  {id:"preference",text:"å±±ã«æ±‚ã‚ã‚‹é­…åŠ›ã§ä¸€ç•ªè¿‘ã„ã®ã¯ï¼Ÿ",options:[
    {icon:"ğŸŒ¸",label:"èŠ±ã‚„æ¤ç‰©ã€ç©ã‚„ã‹ãªè‡ªç„¶ã‚’æ¥½ã—ã¿ãŸã„",score:1},{icon:"ğŸ“¸",label:"çµ¶æ™¯ã®å†™çœŸã‚’æ’®ã‚ŠãŸã„ãƒ»SNSæ˜ ãˆ",score:2},
    {icon:"ğŸ—»",label:"é ‚ä¸Šã«ç«‹ã¤é”æˆæ„Ÿã‚’å‘³ã‚ã„ãŸã„",score:3},{icon:"ğŸ§­",label:"äººã®å°‘ãªã„é™ã‹ãªå±±åŸŸã‚’æ­©ããŸã„",score:4}]},
  {id:"risk",text:"å²©å ´ã‚„é–å ´ã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ™…",label:"çµ¶å¯¾ã«é¿ã‘ãŸã„",score:1},{icon:"ğŸ¤”",label:"å°‘ã—ãªã‚‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ãŸã„",score:2},
    {icon:"ğŸ™‚",label:"ã‚ã‚‹ç¨‹åº¦ã®å²©å ´ãªã‚‰æ¥½ã—ã‚ã‚‹",score:3},{icon:"ğŸ¤©",label:"ã‚¬ãƒ³ã‚¬ãƒ³æ”»ã‚ãŸã„ã€ã‚€ã—ã‚å¥½ã",score:4}]},
];

// ============ STATE ============
let selectedPref="",selectedRegion="";
let curQ=0,totalScore=0,answers={};
let mainMap=null,markerLayer=null,seasonPulseLayer=null;
let courseMarkerMap=new Map();
let allCoursesCache=null;
let activeFilters={equipment:"all",duration:"all"};
let searchKeyword="";
let searchDebounceTimer=null;
let filteredCourses=[];
let visibleUpdateTimer=null;
let sidebarState="landing";
let userLocation=null;
let userMarker=null;
let userAccuracyCircle=null;

// ============ EQUIPMENT & DURATION MAPPING ============
const EQUIPMENT_MAP={"æ•£ç­–":"casual","å…¥é–€":"casual","åˆç´š":"hiking","ä¸­ç´š":"hiking","ä¸­ç´šã€œä¸Šç´š":"hiking","ä¸Šç´š":"hiking","ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ":"hiking"};
const EQ_LABELS={casual:"ç§æœOK",hiking:"ç™»å±±è£…å‚™"};
const EQ_COLORS={casual:"#00796b",hiking:"#c62828"};

function getEquipmentCategory(diff){return EQUIPMENT_MAP[diff]||"hiking";}

function haversineKm(lat1,lng1,lat2,lng2){
  const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function formatDist(km){return km<1?`${Math.round(km*10)/10}km`:km<100?`${Math.round(km)}km`:`ç´„${Math.round(km/10)*10}km`;}

function geoToast(msg){
  const t=document.getElementById('geo-toast');if(!t)return;
  t.textContent=msg;t.classList.add('show');
  clearTimeout(t._tid);t._tid=setTimeout(()=>t.classList.remove('show'),3000);
}
function applyGeoResult(lat,lng,accuracy,approx){
  const btn=document.getElementById('geo-btn');
  userLocation={lat,lng};
  if(btn){btn.classList.remove('geo-loading','geo-error');btn.classList.add('geo-active');}
  if(userMarker){mainMap.removeLayer(userMarker);}
  if(userAccuracyCircle){mainMap.removeLayer(userAccuracyCircle);}
  const ac=approx?'approx':'';
  const icon=L.divIcon({
    className:'',
    html:`<div class="geo-marker"><div class="geo-marker-pulse ${ac}"></div><div class="geo-marker-pulse2 ${ac}"></div><div class="geo-marker-dot ${ac}"></div></div>`,
    iconSize:[20,20],iconAnchor:[10,10],popupAnchor:[0,-12]
  });
  userMarker=L.marker([lat,lng],{icon,pane:'markerPane',interactive:true})
    .addTo(mainMap).bindPopup(approx?'ğŸ“ ãŠãŠã‚ˆãã®ç¾åœ¨åœ°ï¼ˆIPæ¨å®šï¼‰':'ğŸ“ ç¾åœ¨åœ°');
  if(accuracy&&accuracy<50000){
    userAccuracyCircle=L.circle([lat,lng],{
      radius:accuracy,fillColor:'#1565c0',fillOpacity:0.08,color:'#1565c0',weight:1,opacity:0.3,interactive:false
    }).addTo(mainMap);
  }
  mainMap.setView([lat,lng],approx?8:10,{animate:true});
  geoToast(approx?'ãŠãŠã‚ˆãã®ç¾åœ¨åœ°ã‹ã‚‰è¿‘ã„é †ã«ä¸¦ã¹æ›¿ãˆã¾ã—ãŸ':'ç¾åœ¨åœ°ã‹ã‚‰è¿‘ã„é †ã«ä¸¦ã¹æ›¿ãˆã¾ã—ãŸ');
  applyFilters();
}
function ipGeoFallback(){
  geoToast('IPæƒ…å ±ã‹ã‚‰ãŠãŠã‚ˆãã®ä½ç½®ã‚’å–å¾—ä¸­â€¦');
  fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(10000)})
    .then(r=>{if(!r.ok)throw new Error(r.status);return r.json();})
    .then(d=>{
      if(d.latitude&&d.longitude){
        applyGeoResult(d.latitude,d.longitude,null,true);
      } else { throw new Error('no coords'); }
    })
    .catch(e=>{
      console.error('[IP Geolocation fallback]',e);
      const btn=document.getElementById('geo-btn');
      if(btn){btn.classList.remove('geo-loading');btn.classList.add('geo-error');}
      geoToast('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      setTimeout(()=>{if(btn)btn.classList.remove('geo-error');},6000);
    });
}
function toggleGeoLocation(){
  const btn=document.getElementById('geo-btn');if(!btn)return;
  if(userLocation){
    userLocation=null;
    if(userMarker){mainMap.removeLayer(userMarker);userMarker=null;}
    if(userAccuracyCircle){mainMap.removeLayer(userAccuracyCircle);userAccuracyCircle=null;}
    btn.classList.remove('geo-active');
    geoToast('ç¾åœ¨åœ°ã‚’OFFã«ã—ã¾ã—ãŸ');
    applyFilters();
    return;
  }
  if(!navigator.geolocation){geoToast('ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“');btn.classList.add('geo-error');return;}
  btn.classList.add('geo-loading');
  geoToast('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­â€¦');
  navigator.geolocation.getCurrentPosition(pos=>{
    applyGeoResult(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy,false);
  },err=>{
    console.error('[Geolocation]',err.code,err.message);
    if(err.code===2||err.code===3){
      ipGeoFallback();
    } else {
      btn.classList.remove('geo-loading');btn.classList.add('geo-error');
      geoToast(err.code===1?'ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“':'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      setTimeout(()=>btn.classList.remove('geo-error'),6000);
    }
  },{enableHighAccuracy:true,timeout:30000,maximumAge:600000});
}

function parseDurationHours(t){
  if(!t||t==="â€”") return null;
  if(/æ³Š/.test(t)) return Infinity;
  let m;
  if((m=t.match(/(\d+(?:\.\d+)?)[ã€œ~\-](\d+(?:\.\d+)?)æ™‚é–“/))) return(parseFloat(m[1])+parseFloat(m[2]))/2;
  if((m=t.match(/(\d+(?:\.\d+)?)æ™‚é–“/))) return parseFloat(m[1]);
  if((m=t.match(/(\d+)åˆ†[ã€œ~\-](\d+(?:\.\d+)?)æ™‚é–“/))) return(parseInt(m[1])/60+parseFloat(m[2]))/2;
  if((m=t.match(/(\d+)åˆ†/))) return parseInt(m[1])/60;
  return null;
}

function getDurationCategory(t){
  const h=parseDurationHours(t);
  if(h===null) return "unknown";
  if(h===Infinity) return "overnight";
  if(h<=2) return "under2h";
  if(h<=5) return "2to5h";
  return "halfday";
}

// ============ TILE LAYERS ============
const TILE_LAYERS={
  terrain:{url:'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',opts:{attribution:'&copy; <a href="https://opentopomap.org">OpenTopoMap</a>',maxZoom:17}},
  standard:{url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',opts:{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:19}},
  satellite:{url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',opts:{attribution:'&copy; Esri',maxZoom:18}}
};

function addLayerControl(map){
  const C=L.Control.extend({
    options:{position:'topleft'},
    onAdd:function(){
      const d=L.DomUtil.create('div','gmap-layer-ctrl');
      d.innerHTML='<button class="gmap-layer-btn" data-layer="terrain">ğŸ—» åœ°å½¢</button><button class="gmap-layer-btn" data-layer="standard">ğŸ—ºï¸ åœ°å›³</button><button class="gmap-layer-btn active" data-layer="satellite">ğŸ›°ï¸ è¡›æ˜Ÿ</button>';
      L.DomEvent.disableClickPropagation(d);L.DomEvent.disableScrollPropagation(d);
      let cur=L.tileLayer(TILE_LAYERS.satellite.url,TILE_LAYERS.satellite.opts).addTo(map);
      function switchTo(k){
        if(!TILE_LAYERS[k])return;
        d.querySelectorAll('.gmap-layer-btn').forEach(x=>x.classList.remove('active'));
        const ab=d.querySelector(`[data-layer="${k}"]`);if(ab)ab.classList.add('active');
        map.removeLayer(cur);cur=L.tileLayer(TILE_LAYERS[k].url,TILE_LAYERS[k].opts).addTo(map);cur.bringToBack();
      }
      window._switchTileLayer=switchTo;
      d.addEventListener('click',e=>{
        const b=e.target.closest('.gmap-layer-btn');if(!b)return;
        switchTo(b.dataset.layer);
        /* sync mobile balloon */
        document.querySelectorAll('.mob-layer-opt').forEach(x=>x.classList.remove('active'));
        const mb=document.querySelector(`.mob-layer-opt[data-layer="${b.dataset.layer}"]`);if(mb)mb.classList.add('active');
      });
      return d;
    }
  });
  new C().addTo(map);
}

function addLegendControl(map){
  const C=L.Control.extend({
    options:{position:'bottomleft'},
    onAdd:function(){
      const d=L.DomUtil.create('div','map-legend-ctrl');
      d.innerHTML='<div class="ld"><span class="ldot" style="background:#00796b"></span>ç§æœOK</div><div class="ld"><span class="ldot" style="background:#c62828"></span>ç™»å±±è£…å‚™</div><div class="ld" style="margin-left:4px"><span style="font-size:13px">ğŸ”¥</span>æ—¬</div>';
      L.DomEvent.disableClickPropagation(d);
      return d;
    }
  });
  new C().addTo(map);
}

// ============ DIFF KEY MAP (for getAllCourses) ============
const DIFF_KEY_MAP={"å…¥é–€":"entry","åˆç´š":"beginner","ä¸­ç´š":"intermediate","ä¸Šç´š":"advanced","ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ":"expert","ä¸­ç´šã€œä¸Šç´š":"intermediate_advanced","æ•£ç­–":"stroll"};

// ============ getAllCourses ============
function getAllCourses(){
  if(allCoursesCache) return allCoursesCache;
  const all=[],seen=new Set();
  for(const[rk,rv] of Object.entries(mountainDB)){
    for(const lv of["entry","beginner","intermediate","advanced","expert"]){
      const d=rv[lv];if(!d) continue;
      (d.popular||[]).forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);all.push({...c,_category:c.niche?"niche":"popular",_level:lv});}});
      (d.niche||[]).forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);all.push({...c,_category:"niche",_level:lv});}});
    }
  }
  for(const[pref,courses] of Object.entries(prefStrollDB)){
    courses.forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);all.push({...c,pref:pref,_category:"stroll",_level:"stroll"});}});
  }
  allCoursesCache=all;
  return all;
}

// ============ INIT ============
function initApp(){
  initMainMap();
  applyFilters();
  setupMobile();
  updateBookmarkBadge();
  window.addEventListener('resize',()=>{if(mainMap)mainMap.invalidateSize();});
}

function initMainMap(){
  const canvasRenderer=L.canvas({padding:0.5});
  mainMap=L.map('main-map',{zoomControl:false,renderer:canvasRenderer,preferCanvas:true,zoomSnap:0,scrollWheelZoom:false,smoothWheelZoom:true,smoothSensitivity:10}).setView([36.2,138.25],5);
  addGeoControl(mainMap);
  addLayerControl(mainMap);
  addLegendControl(mainMap);
  seasonPulseLayer=L.layerGroup().addTo(mainMap);
  markerLayer=L.layerGroup().addTo(mainMap);
  mainMap.on('moveend',()=>{
    clearTimeout(visibleUpdateTimer);
    visibleUpdateTimer=setTimeout(updateVisibleMarkers,150);
  });
}
function addGeoControl(map){
  const C=L.Control.extend({
    options:{position:'bottomright'},
    onAdd(){
      const wrap=L.DomUtil.create('div','');
      wrap.style.cssText='display:flex;flex-direction:column;align-items:flex-end;gap:8px';
      /* mobile layer toggle */
      const layerWrap=L.DomUtil.create('div','mob-layer-toggle',wrap);
      layerWrap.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 12 2 23 6 12 10"/><polyline points="1 6 1 12 12 16 23 12 23 6"/><polyline points="1 12 1 18 12 22 23 18 23 12"/></svg><div class="mob-layer-balloon" id="mob-layer-balloon"><button class="mob-layer-opt" data-layer="terrain">ğŸ—» åœ°å½¢</button><button class="mob-layer-opt" data-layer="standard">ğŸ—ºï¸ åœ°å›³</button><button class="mob-layer-opt active" data-layer="satellite">ğŸ›°ï¸ è¡›æ˜Ÿ</button></div>';
      L.DomEvent.disableClickPropagation(layerWrap);
      layerWrap.querySelector('svg').addEventListener('click',e=>{
        e.stopPropagation();
        const bl=document.getElementById('mob-layer-balloon');
        bl.classList.toggle('show');
        /* close on outside tap */
        if(bl.classList.contains('show')){
          setTimeout(()=>{
            const closer=ev=>{if(!layerWrap.contains(ev.target)){bl.classList.remove('show');document.removeEventListener('click',closer);}};
            document.addEventListener('click',closer);
          },10);
        }
      });
      layerWrap.querySelector('.mob-layer-balloon').addEventListener('click',e=>{
        const b=e.target.closest('.mob-layer-opt');if(!b)return;
        const k=b.dataset.layer;if(!TILE_LAYERS[k])return;
        layerWrap.querySelectorAll('.mob-layer-opt').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        /* sync with main layer control */
        if(window._switchTileLayer) window._switchTileLayer(k);
        document.getElementById('mob-layer-balloon').classList.remove('show');
      });
      /* geo button */
      const btn=L.DomUtil.create('button','geo-ctrl',wrap);
      btn.id='geo-btn';
      btn.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg>';
      btn.title='ç¾åœ¨åœ°ã‚’è¡¨ç¤º';
      L.DomEvent.disableClickPropagation(btn);
      L.DomEvent.on(btn,'click',toggleGeoLocation);
      return wrap;
    }
  });
  new C().addTo(map);
  const toast=document.createElement('div');toast.className='geo-toast';toast.id='geo-toast';
  document.body.appendChild(toast);
}

// ============ SEARCH ============
function matchesSearch(course,keyword){
  if(!keyword) return true;
  const tokens=keyword.toLowerCase().split(/\s+/).filter(t=>t);
  if(tokens.length===0) return true;
  let searchable=(course.name||'').toLowerCase();
  searchable+=' '+(course.description||'').toLowerCase();
  if(course.pref) searchable+=' '+(Array.isArray(course.pref)?course.pref.join(' '):course.pref).toLowerCase();
  if(course.tags) searchable+=' '+course.tags.map(t=>t.t).join(' ').toLowerCase();
  const hl=COURSE_HIGHLIGHTS[course.name];
  if(hl) searchable+=' '+Object.values(hl).join(' ').toLowerCase();
  return tokens.every(token=>searchable.includes(token));
}

function onSearchInput(value){
  clearTimeout(searchDebounceTimer);
  const clearBtn=document.getElementById('search-clear');
  if(clearBtn) clearBtn.classList.toggle('hidden',!value);
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  searchDebounceTimer=setTimeout(()=>{
    searchKeyword=value.trim();
    applyFilters();
  },300);
}

function clearSearch(){
  const input=document.getElementById('search-input');
  if(input) input.value='';
  const clearBtn=document.getElementById('search-clear');
  if(clearBtn) clearBtn.classList.add('hidden');
  searchKeyword='';
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.map-preset-sub.active').forEach(b=>b.classList.remove('active'));
  const rb=document.getElementById('map-preset-reset');if(rb){rb.style.display='none';rb.classList.remove('show');}
  document.querySelectorAll('.map-preset-cat.has-active').forEach(c=>c.classList.remove('has-active'));
  applyFilters();
}

function applyPreset(btn,keyword){
  const wasActive=btn.classList.contains('active');
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.map-preset-sub.active').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.map-preset-cat.has-active').forEach(c=>c.classList.remove('has-active'));
  const input=document.getElementById('search-input');
  const clearBtn=document.getElementById('search-clear');
  const rb=document.getElementById('map-preset-reset');
  if(wasActive){
    if(input) input.value='';
    if(clearBtn) clearBtn.classList.add('hidden');
    searchKeyword='';
    if(rb){rb.style.display='none';rb.classList.remove('show');}
  } else {
    btn.classList.add('active');
    /* sync map sub chips */
    document.querySelectorAll('.map-preset-sub').forEach(c=>{if(c.textContent===keyword)c.classList.add('active');});
    if(input) input.value=keyword;
    if(clearBtn) clearBtn.classList.remove('hidden');
    searchKeyword=keyword;
    if(rb){rb.style.display='';rb.classList.add('show');}
  }
  applyFilters();
}

// ============ FILTERS ============
function handleFilter(btn,group){
  btn.parentElement.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  activeFilters[group]=btn.dataset.val;
  applyFilters();
}

function applyFilters(){
  if(!markerLayer)return;
  /* exit bookmark mode if active */
  if(bookmarkMode){
    bookmarkMode=false;
    const toggle=document.getElementById('sb-bm-toggle');
    if(toggle) toggle.classList.remove('active');
    document.getElementById('sb-presets').classList.remove('hidden');
    document.querySelector('.sb-filters').classList.remove('hidden');
    document.getElementById('filter-count').classList.remove('hidden');
  }
  const courses=getAllCourses();
  const{equipment,duration}=activeFilters;
  filteredCourses=[];
  courses.forEach(c=>{
    if(equipment!=="all"&&getEquipmentCategory(c.difficulty)!==equipment) return;
    if(duration!=="all"&&getDurationCategory(c.time)!==duration) return;
    if(searchKeyword&&!matchesSearch(c,searchKeyword)) return;
    filteredCourses.push(c);
  });
  document.getElementById('filter-count').textContent=`${filteredCourses.length} ã‚³ãƒ¼ã‚¹è¡¨ç¤ºä¸­`;
  renderCourseList(filteredCourses);
  updateVisibleMarkers();
}

function updateVisibleMarkers(){
  if(!markerLayer||!mainMap||sidebarState==='result')return;
  /* remember which popup is open */
  let openPopupName=null;
  courseMarkerMap.forEach((mk,name)=>{if(mk.isPopupOpen&&mk.isPopupOpen())openPopupName=name;});
  markerLayer.clearLayers();
  if(seasonPulseLayer) seasonPulseLayer.clearLayers();
  courseMarkerMap.clear();
  const bounds=mainMap.getBounds().pad(0.3);
  filteredCourses.forEach(c=>{
    const loc=getCourseLocation(c);if(!loc)return;
    if(!bounds.contains([loc.lat,loc.lng]))return;
    const color=EQ_COLORS[getEquipmentCategory(c.difficulty)]||"#c62828";
    const marker=createMarker(c,color);
    markerLayer.addLayer(marker);
    courseMarkerMap.set(c.name,marker);
  });
  /* restore popup â€“ autoPan:false so the map doesn't jump back */
  const target=openPopupName||_pendingPopupName;
  if(target){
    const mk=courseMarkerMap.get(target);
    if(mk) mk.openPopup({autoPan:false});
  }
}

function createMarker(c,color){
  const loc=getCourseLocation(c);
  const ss=getSeasonScore(c);
  const isSeason=ss>=2;
  const r=isSeason?7:5;
  const eq=getEquipmentCategory(c.difficulty);
  const catLabel=eq==="casual"?"ğŸ‘Ÿ ç§æœOK":"ğŸ¥¾ ç™»å±±è£…å‚™";
  const sl=ss===3?'ğŸ”¥ ä»ŠãŒæ—¬ï¼':ss===2?'âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³':'';
  const reason=seasonReason(c,ss);
  const prefStr=Array.isArray(c.pref)?c.pref.join('ãƒ»'):c.pref;
  const searchUrl=`https://www.google.com/search?q=${encodeURIComponent(c.name)}`;
  const desc=c.description||'';
  const nmEsc=c.name.replace(/'/g,"\\'");
  function buildPopupHtml(){
    const bm=isBookmarked(c.name);
    return `<div class="map-popup-title">${course_season_icon(ss)} ${c.name}</div>
    <div class="map-popup-meta">${catLabel}ãƒ»${c.difficulty}<br>ğŸ“ ${prefStr}<br>â±ï¸ ${c.time}ãƒ»ğŸ“ ${c.elevation}<br>ğŸ“… ${c.season}</div>
    ${desc?`<div style="font-size:11px;color:#444;line-height:1.5;margin-top:4px;border-top:1px solid #eee;padding-top:4px">ğŸ“ ${desc}</div>`:''}
    ${(sl||reason)?`<div class="map-popup-season">${sl}${reason}</div>`:''}
    <a href="${searchUrl}" target="_blank" rel="noopener" style="display:inline-block;margin-top:6px;padding:5px 12px;background:#1a73e8;color:#fff;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none">ğŸ” è©³ç´°ã‚’èª¿ã¹ã‚‹</a><button class="popup-bm-btn${bm?' saved':''}" data-course="${c.name}" onclick="toggleBookmarkFromPopup('${nmEsc}')">${BM_SVG}${bm?' ä¿å­˜æ¸ˆã¿':' ä¿å­˜'}</button>`;
  }
  const bm=isBookmarked(c.name);
  let marker;
  if(bm){
    /* bookmarked â†’ bookmark-shaped icon replaces circle */
    const bmDivIcon=L.divIcon({
      className:'bm-marker-icon',
      html:'<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>',
      iconSize:[22,22],iconAnchor:[11,18]
    });
    marker=L.marker([loc.lat,loc.lng],{icon:bmDivIcon}).bindPopup(buildPopupHtml,{maxWidth:260});
  } else {
    marker=L.circleMarker([loc.lat,loc.lng],{
      radius:r,fillColor:color,color:isSeason?'#ff6f00':'#fff',
      weight:isSeason?2:1.5,fillOpacity:0.9,opacity:1
    }).bindPopup(buildPopupHtml,{maxWidth:260});
  }
  if(isSeason){
    const seasonLabel=ss===3?(getHighlightText(c)||'ğŸ”¥ä»ŠãŒæ—¬'):'âœ¨ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³';
    const ttOff=bm?[0,-6]:[0,-8];
    marker.bindTooltip(seasonLabel,{permanent:true,direction:'top',offset:ttOff,className:'season-tip'});
    /* pulse overlay */
    if(seasonPulseLayer){
      const pulseIcon=L.divIcon({
        className:'season-pulse-wrap',
        html:`<div class="season-pulse-ring ${ss===3?'s3':''}"></div>`,
        iconSize:[14,14],iconAnchor:[7,7]
      });
      seasonPulseLayer.addLayer(L.marker([loc.lat,loc.lng],{icon:pulseIcon,interactive:false}));
    }
  }
  marker.on('popupopen',()=>highlightCard(c.name));
  marker.on('popupclose',()=>unhighlightCard(c.name));
  return marker;
}

function course_season_icon(ss){return ss===3?'ğŸ”¥':ss===2?'âœ¨':'';}

function seasonReason(c,ss){
  if(ss===3){const hl=getHighlightText(c);return hl?`<br><span style="color:#e65100;font-weight:600">ğŸ’¡ ${hl}</span>`:''}
  if(ss===2) return `<br><span style="color:#2e7d32;font-weight:600">ğŸ’¡ ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆ${c.season}ï¼‰ã®è¦‹é ƒæ™‚æœŸã§ã™</span>`;
  return '';
}

// ============ BOOKMARKS ============
let bookmarkMode=false;
function getBookmarks(){try{return JSON.parse(localStorage.getItem('bookmarks'))||[];}catch(e){return [];}}
function saveBookmarks(arr){localStorage.setItem('bookmarks',JSON.stringify(arr));}
function isBookmarked(name){return getBookmarks().includes(name);}
function toggleBookmark(name){
  const bm=getBookmarks();
  const idx=bm.indexOf(name);
  const isAdding=idx===-1;
  if(isAdding) bm.push(name); else bm.splice(idx,1);
  saveBookmarks(bm);
  updateBookmarkUI(name);
  updateBookmarkBadge();
  if(bookmarkMode) renderBookmarkList();
  if(isAdding) flashBookmarkButton();
}
function flashBookmarkButton(){
  const isMobile=window.innerWidth<=768;
  const wasClosed=isMobile&&sheetStop==='closed';
  if(wasClosed) setSheetPosition('peek',true);
  setTimeout(()=>{
    const btn=document.getElementById('sb-bm-toggle');
    if(!btn)return;
    btn.classList.remove('pulse');
    void btn.offsetWidth;
    btn.classList.add('pulse');
    btn.addEventListener('animationend',()=>btn.classList.remove('pulse'),{once:true});
  },wasClosed?400:50);
}
const BM_SVG='<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>';
function updateBookmarkUI(name){
  const saved=isBookmarked(name);
  /* update cards */
  document.querySelectorAll(`.sb-ccard[data-course="${CSS.escape(name)}"] .sb-ccard-bm`).forEach(b=>{
    b.classList.toggle('saved',saved);
  });
  /* update popup buttons */
  document.querySelectorAll('.popup-bm-btn').forEach(btn=>{
    if(btn.dataset.course===name){
      btn.innerHTML=BM_SVG+(saved?' ä¿å­˜æ¸ˆã¿':' ä¿å­˜');
      btn.classList.toggle('saved',saved);
    }
  });
  /* update map marker ring */
  updateVisibleMarkers();
}
function updateBookmarkBadge(){
  const ct=getBookmarks().length;
  const badge=document.getElementById('sb-bm-count');
  if(badge) badge.textContent=ct;
}
/* called from popup via global */
window.toggleBookmarkFromPopup=function(name){toggleBookmark(name);};

function toggleBookmarkView(){
  bookmarkMode=!bookmarkMode;
  const toggle=document.getElementById('sb-bm-toggle');
  if(toggle) toggle.classList.toggle('active',bookmarkMode);
  if(bookmarkMode){
    renderBookmarkList();
    document.getElementById('sb-presets').classList.add('hidden');
    document.querySelector('.sb-filters').classList.add('hidden');
    document.getElementById('filter-count').classList.add('hidden');
  } else {
    document.getElementById('sb-presets').classList.remove('hidden');
    document.querySelector('.sb-filters').classList.remove('hidden');
    document.getElementById('filter-count').classList.remove('hidden');
    renderCourseList(filteredCourses);
  }
}
function renderBookmarkList(){
  const el=document.getElementById('sb-course-list');if(!el)return;
  const bm=getBookmarks();
  if(!bm.length){el.innerHTML='<div class="sb-bm-empty"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg><br>ã¾ã ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:11px;color:#bbb">æ°—ã«ãªã‚‹ã‚³ãƒ¼ã‚¹ã®ã—ãŠã‚Šãƒãƒ¼ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¿å­˜ã—ã¾ã—ã‚‡ã†</span></div>';return;}
  const allC=getAllCourses();
  const courses=bm.map(n=>allC.find(c=>c.name===n)).filter(Boolean);
  /* render inline to avoid applyFilters resetting bookmarkMode */
  const saved=bookmarkMode;
  renderCourseList(courses);
  bookmarkMode=saved;
}

// ============ COURSE LIST ============
function getSearchMatchInfo(course){
  if(!searchKeyword) return '';
  const tokens=searchKeyword.toLowerCase().split(/\s+/).filter(t=>t);
  if(!tokens.length) return '';
  const hl=COURSE_HIGHLIGHTS[course.name];
  if(hl){
    const matched=Object.entries(hl)
      .filter(([m,txt])=>tokens.some(t=>txt.toLowerCase().includes(t)))
      .map(([m,txt])=>`${MONTH_NAMES[parseInt(m)]||m+'æœˆ'}: ${txt}`);
    if(matched.length) return `<div class="sb-ccard-match">ğŸ” ${matched.slice(0,2).join(' / ')}</div>`;
  }
  if(course.description){
    const d=course.description.toLowerCase();
    if(tokens.some(t=>d.includes(t))){
      const snip=course.description.length>40?course.description.slice(0,40)+'â€¦':course.description;
      return `<div class="sb-ccard-match">ğŸ” ${snip}</div>`;
    }
  }
  return '';
}

function renderCourseList(courses){
  const el=document.getElementById('sb-course-list');if(!el)return;
  if(userLocation){
    courses.sort((a,b)=>{
      const la=getCourseLocation(a),lb=getCourseLocation(b);
      return haversineKm(userLocation.lat,userLocation.lng,la.lat,la.lng)-haversineKm(userLocation.lat,userLocation.lng,lb.lat,lb.lng);
    });
  } else {
    courses.sort((a,b)=>getSeasonScore(b)-getSeasonScore(a));
  }
  const show=courses.slice(0,80);
  el.innerHTML=show.map(c=>{
    const ss=getSeasonScore(c);
    const eq=getEquipmentCategory(c.difficulty);
    const eqL=EQ_LABELS[eq]||'';
    const color=EQ_COLORS[getEquipmentCategory(c.difficulty)]||'#c62828';
    const nm=c.name.replace(/'/g,"\\'");
    const desc=c.description?c.description.length>50?c.description.slice(0,50)+'â€¦':c.description:'';
    const matchInfo=getSearchMatchInfo(c);
    let distHtml='';
    if(userLocation){
      const loc=getCourseLocation(c);
      const km=haversineKm(userLocation.lat,userLocation.lng,loc.lat,loc.lng);
      distHtml=`<span class="sb-ccard-dist">ğŸ“ ${formatDist(km)}</span>`;
    }
    const bmSaved=isBookmarked(c.name);
    return `<div class="sb-ccard" data-course="${c.name}" onclick="panToMarker('${nm}')">
      <div class="sb-ccard-h" style="background:${color}">
        <h4>${course_season_icon(ss)} ${c.name}</h4>
        <span class="eq-tag">${eqL}</span>
        <button class="sb-ccard-bm${bmSaved?' saved':''}" onclick="event.stopPropagation();toggleBookmark('${nm}')"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg></button>
      </div>
      <div class="sb-ccard-b">
        ${distHtml}<span>â±ï¸ ${c.time}</span><span>ğŸ“ ${c.elevation}</span><span>ğŸ“… ${c.season}</span>
      </div>
      ${desc&&!matchInfo?`<div class="sb-ccard-desc">ğŸ“ ${desc}</div>`:''}
      ${matchInfo}
    </div>`;
  }).join('');
  if(courses.length>80) el.innerHTML+=`<div class="sb-more">åœ°å›³ã‚’æ‹¡å¤§ã™ã‚‹ã¨æ›´ã«ã‚³ãƒ¼ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>`;
}

let _pendingPopupName=null;
function panToMarker(name){
  _pendingPopupName=name;
  const c=filteredCourses.find(x=>x.name===name)||getAllCourses().find(x=>x.name===name);
  if(!c||!mainMap)return;
  /* mobile: collapse full sheet to peek so the map is visible */
  if(window.innerWidth<=768&&sheetStop==='full') setSheetPosition('peek',true);
  const loc=getCourseLocation(c);if(!loc)return;
  mainMap.setView([loc.lat,loc.lng],12,{animate:true});
  /* open popup after all moveend/updateVisibleMarkers settle */
  const tryOpen=()=>{
    const mk=courseMarkerMap.get(name);
    if(mk){mk.openPopup();_pendingPopupName=null;}
  };
  mainMap.once('moveend',()=>{
    clearTimeout(visibleUpdateTimer);
    updateVisibleMarkers();
    setTimeout(tryOpen,50);
  });
}
function highlightCard(name){
  document.querySelectorAll('.sb-ccard').forEach(el=>el.classList.toggle('highlighted',el.dataset.course===name));
  const card=document.querySelector(`.sb-ccard[data-course="${CSS.escape(name)}"]`);
  if(card) card.scrollIntoView({behavior:'smooth',block:'nearest'});
}
function unhighlightCard(name){
  const card=document.querySelector(`.sb-ccard[data-course="${CSS.escape(name)}"]`);
  if(card) card.classList.remove('highlighted');
}

// ============ SIDEBAR VIEW SWITCHING ============
function switchSidebarView(id){
  document.querySelectorAll('.sb-view').forEach(v=>v.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  sidebarState=id.replace('sb-','');
  document.getElementById('sidebar-body').scrollTop=0;
  if(window.innerWidth<=768) expandSidebar();
  updateFab();
}

function backToLanding(){
  switchSidebarView('sb-landing');
  applyFilters();
  mainMap.setView([36.2,138.25],5,{animate:true});
}

// ============ SIDEBAR TOGGLE (PC) ============
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ro=document.getElementById('sidebar-reopen');
  sb.classList.toggle('collapsed');
  ro.style.display=sb.classList.contains('collapsed')?'block':'none';
  setTimeout(()=>{if(mainMap)mainMap.invalidateSize();},350);
}

// ============ MOBILE ============
/* --- Mobile 3-stop sheet: peek (1/3) | half (legacy compat) | full | closed --- */
let sheetStop='peek'; // 'closed','peek','full'
function getSheetStops(){
  const vh=document.documentElement.clientHeight||window.innerHeight;
  const sbH=Math.round(vh*0.9);
  const peekH=Math.round(vh/3);
  return {closed:sbH-48, peek:sbH-peekH, full:0, sbH, vh, peekH};
}
function setSheetPosition(stop,animate){
  const sb=document.getElementById('sidebar');if(!sb)return;
  const s=getSheetStops();
  const ty=stop==='closed'?s.closed:stop==='peek'?s.peek:0;
  sb.style.transition=animate?'transform .35s cubic-bezier(.2,.9,.3,1)':'none';
  sb.style.transform=`translateY(${ty}px)`;
  sheetStop=stop;
  sb.classList.toggle('collapsed',stop==='closed');
  updateFab();
  updateMapControls();
  setTimeout(()=>{if(mainMap)mainMap.invalidateSize();},380);
}
function updateMapControls(){
  if(window.innerWidth>768)return;
  const s=getSheetStops();
  const sheetVisibleH=sheetStop==='closed'?48:sheetStop==='peek'?s.peekH:s.sbH;
  const bottomPx=Math.max(12,sheetVisibleH+16);
  const ctr=document.querySelector('.leaflet-bottom.leaflet-right');
  if(ctr) ctr.style.bottom=sheetStop==='full'?'':bottomPx+'px';
}
function setupMobile(){
  const handle=document.getElementById('drag-handle');
  const sb=document.getElementById('sidebar');
  if(!handle||window.innerWidth>768) return;
  let startY=0,startTy=0,dragging=false,lastY=0,lastTime=0,velocity=0;
  function curTy(){
    const st=getComputedStyle(sb).transform;
    const mx=new DOMMatrix(st==='none'?'':st);return mx.m42||0;
  }
  function onTouchStart(e){
    startY=e.touches[0].clientY;lastY=startY;lastTime=Date.now();velocity=0;
    startTy=curTy();
    sb.style.transition='none';dragging=true;
    const ctr=document.querySelector('.leaflet-bottom.leaflet-right');
    if(ctr)ctr.style.transition='none';
  }
  function onTouchMove(e){
    if(!dragging)return;
    const y=e.touches[0].clientY;
    const now=Date.now();const dt=now-lastTime;
    if(dt>0) velocity=(y-lastY)/dt;
    lastY=y;lastTime=now;
    const dy=y-startY;
    const ny=Math.max(0,Math.min(getSheetStops().closed,startTy+dy));
    sb.style.transform=`translateY(${ny}px)`;
    /* live-update geo control position */
    const sheetTopNow=sb.getBoundingClientRect().top;
    const vh=window.innerHeight;
    const ctr=document.querySelector('.leaflet-bottom.leaflet-right');
    if(ctr) ctr.style.bottom=Math.max(12,vh-sheetTopNow+16)+'px';
  }
  function onTouchEnd(){
    if(!dragging)return;dragging=false;
    const ctr=document.querySelector('.leaflet-bottom.leaflet-right');
    if(ctr)ctr.style.transition='bottom .35s cubic-bezier(.2,.9,.3,1)';
    const s=getSheetStops();
    const nowTy=curTy();
    const VTHRESH=0.35; /* px/ms â€” light flick threshold */
    let target;
    if(Math.abs(velocity)>VTHRESH){
      /* velocity-based: flick direction decides next stop */
      if(velocity>0){/* swipe down */
        target=sheetStop==='full'?'peek':sheetStop==='peek'?'closed':'closed';
      } else {/* swipe up */
        target=sheetStop==='closed'?'peek':sheetStop==='peek'?'full':'full';
      }
    } else {
      /* position-based: snap to nearest stop */
      const stops=[{k:'full',ty:s.full},{k:'peek',ty:s.peek},{k:'closed',ty:s.closed}];
      target=stops.reduce((a,b)=>Math.abs(nowTy-a.ty)<Math.abs(nowTy-b.ty)?a:b).k;
    }
    setSheetPosition(target,true);
  }
  handle.addEventListener('touchstart',onTouchStart,{passive:true});
  handle.addEventListener('touchmove',onTouchMove,{passive:true});
  handle.addEventListener('touchend',onTouchEnd);
  handle.addEventListener('click',()=>{
    if(sheetStop==='closed') setSheetPosition('peek',true);
    else if(sheetStop==='peek') setSheetPosition('full',true);
  });
  /* build map preset bar */
  buildMapPresetBar();
  /* initial position: peek (1/3) */
  requestAnimationFrame(()=>setSheetPosition('peek',false));
}
function collapseSidebar(){setSheetPosition('closed',true);}
function expandSidebar(){setSheetPosition('full',true);}
function updateFab(){/* removed â€” fab no longer exists */}
function buildMapPresetBar(){
  if(document.getElementById('map-preset-wrap'))return;
  const presets=[
    {cat:'ğŸŒ¸ èŠ±ãƒ»æ¤ç‰©',items:['æ¡œ','ç´…è‘‰','æ–°ç·‘','æ¢…','ãƒ„ãƒ„ã‚¸','ã‚¢ã‚¸ã‚µã‚¤']},
    {cat:'ğŸ”ï¸ è‡ªç„¶',items:['æ¸“è°·','æ»','æµ·','å¯Œå£«å±±','é«˜åŸ','æ£®æ—æµ´','æ¹–']},
    {cat:'ğŸ¯ æ­´å²ãƒ»æ–‡åŒ–',items:['ç¥ç¤¾','å¯º','åŸ','æ¸©æ³‰','ä¸–ç•Œéºç”£']},
    {cat:'ğŸ¥¾ ãƒ†ãƒ¼ãƒ',items:['ã”å½“åœ°ã‚¢ãƒ«ãƒ—ã‚¹','ãƒ­ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«','ç™¾åå±±','å±•æœ›','ç¸¦èµ°']}
  ];
  const wrap=document.createElement('div');wrap.className='map-preset-wrap';wrap.id='map-preset-wrap';
  /* category row */
  const catRow=document.createElement('div');catRow.className='map-preset-cats';
  /* sub-chip row */
  const subRow=document.createElement('div');subRow.className='map-preset-subs';subRow.id='map-preset-subs';
  /* reset button */
  const resetBtn=document.createElement('button');resetBtn.className='map-preset-reset';resetBtn.id='map-preset-reset';
  resetBtn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>';
  resetBtn.style.display='none';
  resetBtn.addEventListener('click',()=>{
    clearMapPreset();
  });
  let openCatIdx=-1;
  function clearMapPreset(){
    subRow.querySelectorAll('.map-preset-sub.active').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
    catRow.querySelectorAll('.map-preset-cat').forEach(c=>{c.classList.remove('has-active');});
    const input=document.getElementById('search-input');
    const clearBtn=document.getElementById('search-clear');
    if(input)input.value='';if(clearBtn)clearBtn.classList.add('hidden');
    searchKeyword='';
    resetBtn.style.display='none';resetBtn.classList.remove('show');
    applyFilters();
  }
  function showSubRow(idx){
    if(openCatIdx===idx){
      /* toggle off */
      subRow.classList.remove('open');
      catRow.querySelectorAll('.map-preset-cat').forEach(c=>c.classList.remove('open'));
      openCatIdx=-1;
      return;
    }
    openCatIdx=idx;
    catRow.querySelectorAll('.map-preset-cat').forEach((c,i)=>{
      c.classList.toggle('open',i===idx);
    });
    /* populate sub items */
    const g=presets[idx];
    subRow.innerHTML='';
    g.items.forEach(kw=>{
      const s=document.createElement('button');s.className='map-preset-sub';s.textContent=kw;
      if(searchKeyword===kw) s.classList.add('active');
      s.addEventListener('click',()=>{
        const wasActive=s.classList.contains('active');
        subRow.querySelectorAll('.map-preset-sub.active').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
        catRow.querySelectorAll('.map-preset-cat').forEach(c=>c.classList.remove('has-active'));
        const input=document.getElementById('search-input');
        const clrBtn=document.getElementById('search-clear');
        if(wasActive){
          if(input)input.value='';if(clrBtn)clrBtn.classList.add('hidden');
          searchKeyword='';
          resetBtn.style.display='none';resetBtn.classList.remove('show');
        } else {
          s.classList.add('active');
          catRow.querySelectorAll('.map-preset-cat')[idx]&&catRow.children[idx].classList.add('has-active');
          document.querySelectorAll('.preset-btn').forEach(b=>{if(b.textContent===kw)b.classList.add('active');});
          if(input)input.value=kw;if(clrBtn)clrBtn.classList.remove('hidden');
          searchKeyword=kw;
          resetBtn.style.display='';resetBtn.classList.add('show');
        }
        applyFilters();
      });
      subRow.appendChild(s);
    });
    subRow.classList.add('open');
  }
  presets.forEach((g,i)=>{
    const btn=document.createElement('button');btn.className='map-preset-cat';btn.textContent=g.cat;
    btn.addEventListener('click',()=>showSubRow(i));
    catRow.appendChild(btn);
  });
  catRow.appendChild(resetBtn);
  wrap.appendChild(catRow);
  wrap.appendChild(subRow);
  document.body.appendChild(wrap);
}

// ============ DIAGNOSIS FLOW ============
function startQuiz(){
  switchSidebarView('sb-pref');
  renderPrefSelector();
}

function renderPrefSelector(){
  const el=document.getElementById("sb-pref");
  let html=`<button class="sb-back" onclick="backToLanding()">â† æˆ»ã‚‹</button>
    <div class="pref-sec"><span class="q-num">STEP 1</span>
    <p class="q-txt">ãŠä½ã¾ã„ã®éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„</p>`;
  for(const[key,r] of Object.entries(REGIONS)){
    html+=`<div class="pref-region"><div class="pref-region-name">${r.name}</div><div class="pref-grid">`;
    r.prefs.forEach(p=>{html+=`<button class="pref-btn" onclick="selectPref(this,'${p}','${key}')">${p.replace(/çœŒ|åºœ|éƒ½/,"")}</button>`;});
    html+=`</div></div>`;
  }
  html+=`</div>`;
  el.innerHTML=html;
}

function selectPref(btn,pref,region){
  document.querySelectorAll(".pref-btn").forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedPref=pref;selectedRegion=region;
  setTimeout(()=>{
    switchSidebarView('sb-quiz');
    curQ=0;totalScore=0;answers={};
    renderQ();
  },300);
}

function renderQ(){
  const q=questions[curQ],total=questions.length;
  const pct=Math.round((curQ/total)*100);
  document.getElementById("p-txt").textContent=`è³ªå• ${curQ+1} / ${total}`;
  document.getElementById("p-pct").textContent=pct+"%";
  document.getElementById("p-fill").style.width=pct+"%";
  document.getElementById("q-box").innerHTML=`
    <div style="animation:fadeIn .25s ease">
      <span class="q-num">Q${curQ+1}</span>
      <p class="q-txt">${q.text}</p>
      <div class="opts">${q.options.map(o=>`
        <button class="opt-btn" onclick="answer('${q.id}',${o.score})">
          <span class="oi">${o.icon}</span><span class="ol">${o.label}</span>
        </button>`).join("")}
      </div>
    </div>`;
}

function answer(id,score){
  answers[id]=score;totalScore+=score;curQ++;
  if(curQ<questions.length) renderQ(); else showDiagnosisResult();
}

function getLevel(s){
  if(s<=10) return "entry";if(s<=14) return "beginner";if(s<=19) return "intermediate";if(s<=24) return "advanced";return "expert";
}

// ============ PREF / NEARBY LOGIC ============
function matchPref(course,pref){
  if(Array.isArray(course.pref)) return course.pref.includes(pref);
  return course.pref===pref;
}
function dedup(arr){const seen=new Set();return arr.filter(c=>{if(seen.has(c.name))return false;seen.add(c.name);return true;});}

function getNearbyPrefExtras(pref,level){
  const adjPrefs=PREF_ADJACENT[pref]||[];
  let extras=[];
  adjPrefs.forEach(ap=>{
    for(const[rk,rv] of Object.entries(mountainDB)){
      const d=rv[level];if(!d) continue;
      const all=[...(d.popular||[]),...(d.niche||[])].filter(c=>matchPref(c,ap));
      if(all.length>0){const pick=all[Math.floor(Math.random()*all.length)];extras.push({...pick,_fromPref:ap});}
    }
  });
  adjPrefs.forEach(ap=>{
    const s=prefStrollDB[ap]||[];
    if(s.length>0){const pick=s[Math.floor(Math.random()*s.length)];extras.push({...pick,_fromPref:ap});}
  });
  return dedup(extras).slice(0,6);
}

// ============ RESULT ============
function renderCard(c,color){
  const eqCat=getEquipmentCategory(c.difficulty);
  const headerColor=eqCat==="casual"?"linear-gradient(135deg,#00796b,#26a69a)":"linear-gradient(135deg,#b71c1c,#c62828)";
  const badge=eqCat==="casual"?'<span class="stroll-b">ğŸ‘Ÿ ç§æœOK</span>':'<span class="niche-b">ğŸ¥¾ ç™»å±±è£…å‚™</span>';
  const ss=getSeasonScore(c);
  const hl=getHighlightText(c);
  let siHtml='';
  if(ss===3) siHtml=`<div class="season-indicator"><span class="si-badge si-highlight">ğŸ”¥ ä»ŠãŒæ—¬ï¼</span><span class="highlight-text">${hl}</span></div>`;
  else if(ss===2) siHtml=`<div class="season-indicator"><span class="si-badge si-best">âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³</span></div>`;
  const nm=c.name.replace(/'/g,"\\'");
  return `<div class="card" onclick="panToMarker('${nm}')">
    <div class="card-h" style="background:${headerColor}">
      <h3>${c.name}${badge}${ss===3?'<span class="now-tag">NOW</span>':''}</h3>
      <span class="diff-tag">${c.difficulty}</span>
    </div>
    <div class="card-b">
      ${siHtml}
      <div class="c-meta"><span>â±ï¸ ${c.time}</span><span>ğŸ“ ${c.elevation}</span><span>ğŸ“… ${c.season}</span></div>
      <div class="c-tags">${c.tags.map(t=>`<span class="tag ${t.c}">${t.t}</span>`).join("")}</div>
      <p class="c-desc">${c.description}</p>
      <div class="c-tips"><strong>ğŸ’¡ ãƒ„ã‚¦æƒ…å ±ï¼š</strong>${c.tips}</div>
    </div>
  </div>`;
}

function buildSeasonPanel(region,level){
  const m=getCurrentMonth();const s=getSeason(m);const sl=getSeasonLabel(m);
  const advice=SEASONAL_ADVICE[region]&&SEASONAL_ADVICE[region][m];if(!advice) return '';
  const bgClass={spring:"spring-bg",summer:"summer-bg",autumn:"autumn-bg",winter:"winter-bg"}[s];
  const lvWarn=LEVEL_SEASON_WARNINGS[level]&&LEVEL_SEASON_WARNINGS[level][s];
  return `<div class="season-panel">
    <div class="season-header ${bgClass}"><span class="s-icon">${advice.icon}</span>
      <div><div class="s-title">${MONTH_NAMES[m]}ï¼ˆ${sl}ï¼‰ã®${selectedPref}ã‚¨ãƒªã‚¢</div>
      <div class="s-month">ä»Šã®æ™‚æœŸã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼†ãŠã™ã™ã‚</div></div>
    </div>
    <div class="season-body">
      <div class="season-summary">${advice.summary}</div>
      <div class="season-warn"><strong>âš ï¸ æ³¨æ„ï¼š</strong>${advice.warn}</div>
      <div class="season-recommend"><strong>ğŸŒŸ ä»Šæœˆã®ãŠã™ã™ã‚ï¼š</strong>${advice.recommend}</div>
      ${lvWarn?`<div class="level-season-note"><strong>ğŸ“‹ ${LEVEL_META[level].level}ãƒ¬ãƒ™ãƒ«ã®æ–¹ã¸ï¼š</strong>${lvWarn}</div>`:''}
    </div>
  </div>`;
}

function showDiagnosisResult(){
  switchSidebarView('sb-result');
  const level=getLevel(totalScore);
  const meta=LEVEL_META[level];
  const color=LEVEL_COLORS[level];

  let pop=[],niche=[];
  for(const[rk,rv] of Object.entries(mountainDB)){
    const d=rv[level];if(!d) continue;
    pop.push(...(d.popular||[]).filter(c=>matchPref(c,selectedPref)));
    niche.push(...(d.niche||[]).filter(c=>matchPref(c,selectedPref)));
  }
  pop=dedup(pop);niche=dedup(niche);
  const strolls=prefStrollDB[selectedPref]||[];
  const nearby=getNearbyPrefExtras(selectedPref,level);

  const allLocal=[...pop,...niche,...strolls];
  const nowPicks=allLocal.filter(c=>getSeasonScore(c)>=2).sort((a,b)=>getSeasonScore(b)-getSeasonScore(a));
  const seasonPanel=buildSeasonPanel(selectedRegion,level);
  const nearbyPrefs=[...new Set(nearby.map(c=>c._fromPref))];
  const hasMountain=pop.length+niche.length>0;

  let html=`<div class="r-sec">
    <button class="sb-back" onclick="backToLanding()">â† ã‚³ãƒ¼ã‚¹åœ°å›³ã«æˆ»ã‚‹</button>
    <span class="r-badge lv-${level}">ğŸ¯ ã‚ãªãŸã¯ã€Œ${meta.level}ã€ãƒ¬ãƒ™ãƒ«</span>
    <div class="r-region">ğŸ“ ${selectedPref} ã®ãŠã™ã™ã‚</div>
    <div class="r-sum"><p>${meta.message}</p></div>
    ${seasonPanel}
    ${!hasMountain?`<div class="stroll-note" style="background:#e3f2fd;color:#1565c0"><strong>â„¹ï¸ ${selectedPref}ã«ã¯æ²è¼‰ä¸­ã®ç™»å±±ã‚³ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong>æ•£ç­–è·¯ã¨è¿‘éš£çœŒã®ã‚³ãƒ¼ã‚¹ã‚’ã”è¦§ãã ã•ã„ï¼</div>`:''}
    <div class="cards">
      ${nowPicks.length?`<div class="stroll-note" style="background:#fff3e0;color:#e65100"><strong>ğŸ”¥ ${MONTH_NAMES[getCurrentMonth()]}ã«è¡Œããªã‚‰ã“ã“ï¼</strong></div>`:''}
      ${nowPicks.map(c=>renderCard(c,color)).join("")}
      ${pop.filter(c=>getSeasonScore(c)<2).map(c=>renderCard(c,color)).join("")}
      ${niche.filter(c=>getSeasonScore(c)<2).map(c=>renderCard(c,color)).join("")}
      ${strolls.length?`<div class="stroll-note"><strong>ğŸ‘Ÿ ç§æœã§æ¥½ã—ã‚ã‚‹ã‚³ãƒ¼ã‚¹</strong> â€” ç™»å±±è£…å‚™ãªã—ã§OK</div>`:''}
      ${strolls.filter(c=>getSeasonScore(c)<2).map(c=>renderCard(c,color)).join("")}
      ${nearby.length?`<div class="nearby-note"><strong>ğŸš— è¿‘éš£çœŒã®ãŠã™ã™ã‚</strong>ï¼ˆ${nearbyPrefs.join("ãƒ»")}ï¼‰</div>`:''}
      ${nearby.map(c=>renderCard(c,color)).join("")}
    </div>
    <button class="btn-restart" onclick="backToLanding()">ğŸ—ºï¸ ã‚³ãƒ¼ã‚¹åœ°å›³ã«æˆ»ã‚‹</button>
    <button class="btn-restart" onclick="startQuiz()">ğŸ“‹ ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
  </div>`;
  document.getElementById('sb-result').innerHTML=html;

  // Update map to show only diagnosis results
  markerLayer.clearLayers();if(seasonPulseLayer)seasonPulseLayer.clearLayers();courseMarkerMap.clear();
  const allDiag=[...pop,...niche,...strolls,...nearby];
  allDiag.forEach(c=>{
    const clr=c._fromPref?'#1565c0':EQ_COLORS[getEquipmentCategory(c.difficulty)]||'#c62828';
    const loc=getCourseLocation(c);if(!loc)return;
    const m=createMarker(c,clr);
    markerLayer.addLayer(m);courseMarkerMap.set(c.name,m);
  });
  const center=PREF_CENTER[selectedPref]||{lat:36.2,lng:138.25};
  const bounds=[];
  markerLayer.eachLayer(m=>{if(m.getLatLng)bounds.push(m.getLatLng());});
  if(bounds.length>0) mainMap.fitBounds(L.latLngBounds(bounds),{padding:[30,30],maxZoom:11});
  else mainMap.setView([center.lat,center.lng],9,{animate:true});
}

// ============ BOOT ============
document.addEventListener('DOMContentLoaded',initApp);
</script>
</body>
</html>
