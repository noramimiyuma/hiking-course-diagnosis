<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ç™»å±±ã‚³ãƒ¼ã‚¹è¨ºæ–­</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Hiragino Sans","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:linear-gradient(135deg,#1a472a 0%,#2d6a4f 30%,#52796f 60%,#84a98c 100%);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:24px 16px}
    .app{background:rgba(255,255,255,.96);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:680px;width:100%;overflow:hidden;margin:20px 0}
    .hdr{background:linear-gradient(135deg,#1b4332,#2d6a4f,#40916c);color:#fff;padding:28px 24px;text-align:center;position:relative;overflow:hidden}
    .hdr::before{content:"";position:absolute;top:-30px;right:-30px;width:140px;height:140px;background:rgba(255,255,255,.06);border-radius:50%}
    .hdr-icon{font-size:42px;margin-bottom:8px}
    .hdr h1{font-size:21px;font-weight:700;letter-spacing:1px}
    .hdr p{font-size:13px;opacity:.8;margin-top:4px}
    .cnt{padding:24px 22px}

    /* progress */
    .prog{margin-bottom:22px}.prog-lbl{font-size:13px;color:#666;margin-bottom:6px;display:flex;justify-content:space-between}
    .prog-bar{height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden}
    .prog-fill{height:100%;background:linear-gradient(90deg,#40916c,#52b788);border-radius:3px;transition:width .4s}

    /* question */
    .q-sec{animation:fadeIn .35s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .q-num{display:inline-block;background:#2d6a4f;color:#fff;font-size:12px;font-weight:700;padding:4px 12px;border-radius:20px;margin-bottom:10px}
    .q-txt{font-size:17px;font-weight:600;color:#1b1b1b;margin-bottom:18px;line-height:1.6}
    .opts{display:flex;flex-direction:column;gap:8px}
    .opt-btn{display:flex;align-items:center;gap:12px;padding:13px 16px;background:#f8faf8;border:2px solid #e0e8e0;border-radius:12px;cursor:pointer;font-size:14px;color:#333;transition:all .2s;text-align:left}
    .opt-btn:hover{border-color:#52b788;background:#edf7f0;transform:translateX(4px)}
    .opt-btn .oi{font-size:22px;flex-shrink:0}.opt-btn .ol{line-height:1.4}

    /* prefecture selector */
    .pref-sec{animation:fadeIn .35s ease}
    .pref-region{margin-bottom:16px}
    .pref-region-name{font-size:13px;font-weight:700;color:#2d6a4f;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #e0e8e0}
    .pref-grid{display:flex;flex-wrap:wrap;gap:6px}
    .pref-btn{padding:8px 12px;border:2px solid #e0e8e0;border-radius:8px;background:#f8faf8;font-size:13px;color:#333;cursor:pointer;transition:all .2s}
    .pref-btn:hover{border-color:#52b788;background:#edf7f0}
    .pref-btn.selected{border-color:#2d6a4f;background:#2d6a4f;color:#fff}

    /* start */
    .start{text-align:center;padding:12px 0}
    .start-d{color:#555;font-size:15px;line-height:1.8;margin-bottom:18px}
    .start-f{display:flex;justify-content:center;gap:20px;margin-bottom:24px;flex-wrap:wrap}
    .start-fi{text-align:center;font-size:12px;color:#777}.start-fi .fi{font-size:26px;margin-bottom:2px}
    .btn-main{display:inline-block;background:linear-gradient(135deg,#1b4332,#2d6a4f);color:#fff;font-size:16px;font-weight:600;padding:14px 44px;border:none;border-radius:30px;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 16px rgba(27,67,50,.3)}
    .btn-main:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(27,67,50,.4)}

    /* result */
    .r-sec{animation:fadeIn .5s ease}
    .r-badge{display:inline-block;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:700;margin-bottom:10px}
    .lv-entry{background:#e8f5e9;color:#1b5e20}
    .lv-beginner{background:#d8f3dc;color:#1b4332}
    .lv-intermediate{background:#fff3cd;color:#7c5e10}
    .lv-advanced{background:#ffd6cc;color:#9c2c0c}
    .lv-expert{background:#e8d0f0;color:#4a148c}
    .r-region{font-size:13px;color:#666;margin-bottom:14px}
    .r-sum{background:#f5f9f6;border-radius:12px;padding:14px 16px;margin-bottom:20px}
    .r-sum p{font-size:14px;color:#555;line-height:1.7}

    /* tabs */
    .tabs{margin-bottom:18px}
    .tab-btns{display:flex;border-bottom:2px solid #e0e8e0}
    .tab-b{flex:1;padding:9px 6px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:13px;font-weight:600;color:#999;transition:all .2s;margin-bottom:-2px}
    .tab-b.active{color:#2d6a4f;border-bottom-color:#2d6a4f}
    .tab-b:hover{color:#40916c}
    .tab-c{display:none;padding-top:14px}.tab-c.active{display:block}

    /* cards */
    .cards{display:flex;flex-direction:column;gap:12px}
    .card{border:1px solid #e0e8e0;border-radius:14px;overflow:hidden;transition:box-shadow .2s}
    .card:hover{box-shadow:0 4px 14px rgba(0,0,0,.08)}
    .card-h{padding:12px 16px;color:#fff;display:flex;justify-content:space-between;align-items:center}
    .card-h h3{font-size:14px;font-weight:700}
    .diff-tag{font-size:10px;background:rgba(255,255,255,.25);padding:3px 9px;border-radius:10px}
    .card-b{padding:12px 16px}
    .c-meta{display:flex;flex-wrap:wrap;gap:4px 12px;margin-bottom:8px}
    .c-meta span{font-size:12px;color:#777}
    .c-desc{font-size:13px;color:#444;line-height:1.7;margin-bottom:8px}
    .c-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
    .tag{font-size:11px;padding:2px 8px;border-radius:6px;font-weight:600}
    .tag-highlight{background:#fff3cd;color:#856404}.tag-niche{background:#e8d5f5;color:#6a1b9a}
    .tag-view{background:#d1ecf1;color:#0c5460}.tag-nature{background:#d4edda;color:#155724}
    .tag-season{background:#ffe0e6;color:#8b1a2b}
    .tag-stroll{background:#e0f2f1;color:#00695c}
    .c-tips{background:#f8faf8;border-radius:8px;padding:8px 12px;font-size:12px;color:#666;line-height:1.6}
    .c-tips strong{color:#2d6a4f}
    .niche-b{display:inline-block;background:linear-gradient(135deg,#7b1fa2,#9c27b0);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;margin-left:6px;vertical-align:middle}
    .stroll-b{display:inline-block;background:linear-gradient(135deg,#00796b,#26a69a);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;margin-left:6px;vertical-align:middle}
    .stroll-note{margin-bottom:14px;padding:12px 16px;background:#e0f2f1;border-radius:10px;font-size:13px;color:#00695c;line-height:1.6}
    .stroll-note strong{color:#004d40}

    /* seasonal */
    .season-panel{margin-bottom:18px;border-radius:14px;overflow:hidden;border:1px solid #e0e8e0}
    .season-header{padding:14px 16px;color:#fff;display:flex;align-items:center;gap:10px}
    .season-header .s-icon{font-size:28px}
    .season-header .s-title{font-size:15px;font-weight:700}
    .season-header .s-month{font-size:12px;opacity:.85;margin-top:2px}
    .season-body{padding:14px 16px;background:#fff}
    .season-summary{font-size:14px;color:#333;line-height:1.7;margin-bottom:10px}
    .season-warn{font-size:12px;color:#c62828;background:#ffebee;padding:8px 12px;border-radius:8px;margin-bottom:8px;line-height:1.5}
    .season-recommend{font-size:12px;color:#2e7d32;background:#e8f5e9;padding:8px 12px;border-radius:8px;line-height:1.5}
    .season-recommend strong,.season-warn strong{font-weight:700}
    .level-season-note{font-size:12px;color:#555;background:#f5f5f5;padding:8px 12px;border-radius:8px;margin-top:8px;line-height:1.5}
    .spring-bg{background:linear-gradient(135deg,#e91e63,#f06292)}
    .summer-bg{background:linear-gradient(135deg,#00897b,#26a69a)}
    .autumn-bg{background:linear-gradient(135deg,#e65100,#ff8f00)}
    .winter-bg{background:linear-gradient(135deg,#1565c0,#42a5f5)}

    /* card season indicators */
    .season-indicator{display:flex;align-items:center;gap:6px;margin-bottom:8px}
    .si-badge{font-size:11px;font-weight:700;padding:3px 10px;border-radius:12px;display:inline-flex;align-items:center;gap:4px}
    .si-best{background:linear-gradient(135deg,#ff6f00,#ff8f00);color:#fff}
    .si-highlight{background:linear-gradient(135deg,#d32f2f,#e53935);color:#fff;animation:pulse 2s infinite}
    .si-ok{background:#e8f5e9;color:#2e7d32}
    .si-offseason{background:#f5f5f5;color:#999}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.85}}
    .highlight-text{font-size:12px;color:#c62828;font-weight:600;margin-left:4px}
    .now-tag{display:inline-block;background:linear-gradient(135deg,#ff6f00,#ff8f00);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:5px;vertical-align:middle}

    .btn-restart{display:block;width:100%;margin-top:20px;padding:12px;background:#fff;border:2px solid #2d6a4f;color:#2d6a4f;font-size:15px;font-weight:600;border-radius:12px;cursor:pointer;transition:all .2s}
    .btn-restart:hover{background:#2d6a4f;color:#fff}
    .hidden{display:none}

    /* nearby note */
    .nearby-note{margin-top:16px;padding:12px 16px;background:#f0f4f8;border-radius:10px;font-size:13px;color:#555;line-height:1.6}
    .nearby-note strong{color:#2d6a4f}

    @media(max-width:480px){.cnt{padding:18px 14px}.pref-btn{padding:6px 10px;font-size:12px}.tab-b{font-size:12px;padding:7px 4px}}
    /* map */
    #map-container{height:400px;border-radius:12px;overflow:hidden;border:1px solid #e0e8e0}
    @media(max-width:480px){#map-container{height:300px}}
    .map-legend{display:flex;flex-wrap:wrap;gap:6px 12px;margin-top:10px;padding:10px 14px;background:#f8faf8;border-radius:10px;font-size:12px;color:#555}
    .map-legend-item{display:flex;align-items:center;gap:4px}
    .map-legend-dot{width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}
    .map-popup-title{font-size:14px;font-weight:700;color:#1b4332;margin-bottom:4px}
    .map-popup-meta{font-size:12px;color:#666;line-height:1.5}
    .map-popup-season{font-size:11px;margin-top:4px}

    /* all-courses map */
    .btn-allmap{background:#fff;border:2px solid #2d6a4f;color:#2d6a4f;font-size:14px;font-weight:600;padding:10px 28px;border-radius:24px;cursor:pointer;transition:all .2s}
    .btn-allmap:hover{background:#2d6a4f;color:#fff;box-shadow:0 4px 12px rgba(27,67,50,.25)}
    .allmap-header{margin-bottom:16px}
    .allmap-back{background:none;border:none;color:#2d6a4f;font-size:13px;font-weight:600;cursor:pointer;padding:4px 0;margin-bottom:8px;display:inline-block}
    .allmap-back:hover{text-decoration:underline}
    .allmap-title{font-size:19px;font-weight:700;color:#1b4332;margin-bottom:4px}
    .allmap-subtitle{font-size:13px;color:#777}
    .allmap-filters{margin-bottom:12px}
    .allmap-filter-group{margin-bottom:10px}
    .allmap-filter-label{font-size:12px;font-weight:700;color:#555;display:block;margin-bottom:6px}
    .allmap-filter-btns{display:flex;flex-wrap:wrap;gap:6px}
    .allmap-fbtn{padding:6px 12px;border:2px solid #e0e8e0;border-radius:8px;background:#f8faf8;font-size:12px;color:#555;cursor:pointer;transition:all .2s;font-weight:600}
    .allmap-fbtn:hover{border-color:#52b788;background:#edf7f0}
    .allmap-fbtn.active{border-color:#2d6a4f;background:#2d6a4f;color:#fff}
    .allmap-count{font-size:13px;color:#666;margin-bottom:8px;text-align:right}
    #allmap-container{height:500px;border-radius:12px;overflow:hidden;border:1px solid #e0e8e0}
    @media(max-width:480px){#allmap-container{height:380px}.allmap-fbtn{padding:5px 9px;font-size:11px}}
  </style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="hdr-icon">ğŸ”ï¸</div>
    <h1>ç™»å±±ã‚³ãƒ¼ã‚¹è¨ºæ–­</h1>
    <p>ãŠä½ã¾ã„ã®ã‚¨ãƒªã‚¢ã«åˆã‚ã›ãŸãŠã™ã™ã‚ã‚³ãƒ¼ã‚¹ã‚’ææ¡ˆ</p>
  </div>
  <div class="cnt">
    <!-- Start -->
    <div id="v-start" class="start">
      <p class="start-d">ã‚ãªãŸã®ä½“åŠ›ãƒ»ç”Ÿæ´»ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ãŠä½ã¾ã„ã®åœ°åŸŸã«åˆã‚ã›ã¦<br>å®šç•ªã‹ã‚‰çŸ¥ã‚‹äººãçŸ¥ã‚‹ç©´å ´ã€æ°—è»½ãªè‡ªç„¶æ•£ç­–è·¯ã¾ã§<br>æœ€é©ãªã‚³ãƒ¼ã‚¹ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚</p>
      <div class="start-f">
        <div class="start-fi"><div class="fi">ğŸ“‹</div>å…¨8å•</div>
        <div class="start-fi"><div class="fi">ğŸ—¾</div>47éƒ½é“åºœçœŒå¯¾å¿œ</div>
        <div class="start-fi"><div class="fi">ğŸ’</div>ç©´å ´ã‚³ãƒ¼ã‚¹åéŒ²</div>
        <div class="start-fi"><div class="fi">ğŸŒ¿</div>è‡ªç„¶æ•£ç­–è·¯</div>
      </div>
      <button class="btn-main" onclick="startQuiz()">è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹</button>
      <div style="margin-top:14px">
        <button class="btn-allmap" onclick="showAllMap()">ğŸ—ºï¸ å…¨å›½ã‚³ãƒ¼ã‚¹åœ°å›³ã‚’è¦‹ã‚‹</button>
      </div>
    </div>

    <!-- Prefecture -->
    <div id="v-pref" class="hidden"></div>

    <!-- Questions -->
    <div id="v-quiz" class="hidden">
      <div class="prog">
        <div class="prog-lbl"><span id="p-txt"></span><span id="p-pct"></span></div>
        <div class="prog-bar"><div class="prog-fill" id="p-fill"></div></div>
      </div>
      <div id="q-box"></div>
    </div>

    <!-- Result -->
    <div id="v-result" class="hidden"></div>

    <!-- All Courses Map -->
    <div id="v-allmap" class="hidden">
      <div class="allmap-header">
        <button class="allmap-back" onclick="backToStart()">â† ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹</button>
        <div class="allmap-title">ğŸ—ºï¸ å…¨å›½ã‚³ãƒ¼ã‚¹åœ°å›³</div>
        <div class="allmap-subtitle">å…¨ã‚³ãƒ¼ã‚¹ã‚’åœ°å›³ã§æ¢ç´¢ã§ãã¾ã™</div>
      </div>
      <div class="allmap-filters">
        <div class="allmap-filter-group">
          <label class="allmap-filter-label">ç¨®é¡</label>
          <div class="allmap-filter-btns" id="filter-type">
            <button class="allmap-fbtn active" data-val="all" onclick="toggleAllMapFilter(this,'type')">ã™ã¹ã¦</button>
            <button class="allmap-fbtn" data-val="popular" onclick="toggleAllMapFilter(this,'type')">å®šç•ª</button>
            <button class="allmap-fbtn" data-val="niche" onclick="toggleAllMapFilter(this,'type')">ç©´å ´</button>
            <button class="allmap-fbtn" data-val="stroll" onclick="toggleAllMapFilter(this,'type')">æ•£ç­–è·¯</button>
          </div>
        </div>
        <div class="allmap-filter-group">
          <label class="allmap-filter-label">é›£æ˜“åº¦</label>
          <div class="allmap-filter-btns" id="filter-diff">
            <button class="allmap-fbtn active" data-val="all" onclick="toggleAllMapFilter(this,'diff')">ã™ã¹ã¦</button>
            <button class="allmap-fbtn" data-val="entry" onclick="toggleAllMapFilter(this,'diff')">å…¥é–€</button>
            <button class="allmap-fbtn" data-val="beginner" onclick="toggleAllMapFilter(this,'diff')">åˆç´š</button>
            <button class="allmap-fbtn" data-val="intermediate" onclick="toggleAllMapFilter(this,'diff')">ä¸­ç´š</button>
            <button class="allmap-fbtn" data-val="advanced" onclick="toggleAllMapFilter(this,'diff')">ä¸Šç´š</button>
            <button class="allmap-fbtn" data-val="expert" onclick="toggleAllMapFilter(this,'diff')">ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ</button>
            <button class="allmap-fbtn" data-val="stroll" onclick="toggleAllMapFilter(this,'diff')">æ•£ç­–</button>
          </div>
        </div>
      </div>
      <div class="allmap-count" id="allmap-count"></div>
      <div id="allmap-container"></div>
      <div class="map-legend" style="margin-top:10px">
        <div class="map-legend-item"><span class="map-legend-dot" style="background:#2d6a4f"></span>å®šç•ª</div>
        <div class="map-legend-item"><span class="map-legend-dot" style="background:#7b1fa2"></span>ç©´å ´</div>
        <div class="map-legend-item"><span class="map-legend-dot" style="background:#00796b"></span>æ•£ç­–è·¯</div>
      </div>
      <div style="margin-top:16px;display:flex;gap:10px">
        <button class="btn-restart" style="flex:1;margin-top:0" onclick="backToStart()">ğŸ  ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹</button>
        <button class="btn-restart" style="flex:1;margin-top:0;background:#2d6a4f;color:#fff" onclick="startQuiz()">ğŸ“‹ è¨ºæ–­ã‚’ã¯ã˜ã‚ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="mountains.js"></script>
<script>
// ============ QUESTIONS ============
const questions=[
  {id:"exercise",text:"æ™®æ®µã®é‹å‹•ç¿’æ…£ã‚’æ•™ãˆã¦ãã ã•ã„",options:[
    {icon:"ğŸ›‹ï¸",label:"ã»ã¨ã‚“ã©é‹å‹•ã—ãªã„",score:1},{icon:"ğŸš¶",label:"é€±1ã€œ2å›ã€æ•£æ­©ã‚„ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ã™ã‚‹",score:2},
    {icon:"ğŸƒ",label:"é€±3å›ä»¥ä¸Šã€ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚„ç­‹ãƒˆãƒ¬ã‚’ã™ã‚‹",score:3},{icon:"ğŸ’ª",label:"æ¯æ—¥ãƒãƒ¼ãƒ‰ãªé‹å‹•ã‚’ã—ã¦ã„ã‚‹",score:4}]},
  {id:"weekend",text:"é€±æœ«ã¯ã©ã®ã‚ˆã†ã«éã”ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ“º",label:"å®¶ã§ã‚†ã£ãã‚Šéã”ã™",score:1},{icon:"ğŸ›ï¸",label:"è²·ã„ç‰©ã‚„è¡—æ­©ãã«å‡ºã‹ã‘ã‚‹",score:2},
    {icon:"ğŸŒ³",label:"å…¬åœ’ã‚„è‡ªç„¶ã®ä¸­ã§éã”ã™",score:3},{icon:"ğŸ§—",label:"ç™»å±±ãƒ»ã‚­ãƒ£ãƒ³ãƒ—ãªã©ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«éã”ã™",score:4}]},
  {id:"stamina",text:"éšæ®µã®ä¸Šã‚Šä¸‹ã‚Šã«ã¤ã„ã¦ã©ã†æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ˜µ",label:"3éšåˆ†ã§ã‚‚ã‹ãªã‚Šãã¤ã„",score:1},{icon:"ğŸ˜…",label:"5éšåˆ†ãã‚‰ã„ãªã‚‰ä½•ã¨ã‹å¤§ä¸ˆå¤«",score:2},
    {icon:"ğŸ˜Š",label:"10éšåˆ†ãã‚‰ã„ã¯ä½™è£•",score:3},{icon:"ğŸ˜¤",label:"ä½•éšã§ã‚‚ã¾ã£ãŸãè‹¦ã«ãªã‚‰ãªã„",score:4}]},
  {id:"hiking_exp",text:"ç™»å±±ã‚„ãƒã‚¤ã‚­ãƒ³ã‚°ã®çµŒé¨“ã¯ã©ã®ãã‚‰ã„ã§ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ”°",label:"ã¾ã£ãŸãã®æœªçµŒé¨“",score:1},{icon:"ğŸ‘Ÿ",label:"ãƒã‚¤ã‚­ãƒ³ã‚°ç¨‹åº¦ãªã‚‰æ•°å›ã‚ã‚‹",score:2},
    {icon:"ğŸ¥¾",label:"æ—¥å¸°ã‚Šç™»å±±ã‚’ä½•åº¦ã‚‚çµŒé¨“ã—ã¦ã„ã‚‹",score:3},{icon:"â›°ï¸",label:"å±±å°å±‹æ³Šãƒ»ç¸¦èµ°ãªã©æœ¬æ ¼çš„ãªçµŒé¨“ãŒè±Šå¯Œ",score:4}]},
  {id:"duration",text:"1å›ã®å±±è¡Œã«ã‹ã‘ã‚‰ã‚Œã‚‹æ™‚é–“ã¯ï¼Ÿ",options:[
    {icon:"â°",label:"2ã€œ3æ™‚é–“ãŒé™åº¦",score:1},{icon:"ğŸ•",label:"åŠæ—¥ï¼ˆ4ã€œ5æ™‚é–“ï¼‰ãã‚‰ã„",score:2},
    {icon:"ğŸŒ…",label:"ä¸¸ä¸€æ—¥ï¼ˆ6ã€œ8æ™‚é–“ï¼‰ã‹ã‘ã¦OK",score:3},{icon:"ğŸ•ï¸",label:"æ³Šã¾ã‚ŠãŒã‘ã§ã‚‚OK",score:4}]},
  {id:"preference",text:"å±±ã«æ±‚ã‚ã‚‹é­…åŠ›ã§ä¸€ç•ªè¿‘ã„ã®ã¯ï¼Ÿ",options:[
    {icon:"ğŸŒ¸",label:"èŠ±ã‚„æ¤ç‰©ã€ç©ã‚„ã‹ãªè‡ªç„¶ã‚’æ¥½ã—ã¿ãŸã„",score:1},{icon:"ğŸ“¸",label:"çµ¶æ™¯ã®å†™çœŸã‚’æ’®ã‚ŠãŸã„ãƒ»SNSæ˜ ãˆ",score:2},
    {icon:"ğŸ—»",label:"é ‚ä¸Šã«ç«‹ã¤é”æˆæ„Ÿã‚’å‘³ã‚ã„ãŸã„",score:3},{icon:"ğŸ§­",label:"äººã®å°‘ãªã„é™ã‹ãªå±±åŸŸã‚’æ­©ããŸã„",score:4}]},
  {id:"risk",text:"å²©å ´ã‚„é–å ´ã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿ",options:[
    {icon:"ğŸ™…",label:"çµ¶å¯¾ã«é¿ã‘ãŸã„",score:1},{icon:"ğŸ¤”",label:"å°‘ã—ãªã‚‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ãŸã„",score:2},
    {icon:"ğŸ™‚",label:"ã‚ã‚‹ç¨‹åº¦ã®å²©å ´ãªã‚‰æ¥½ã—ã‚ã‚‹",score:3},{icon:"ğŸ¤©",label:"ã‚¬ãƒ³ã‚¬ãƒ³æ”»ã‚ãŸã„ã€ã‚€ã—ã‚å¥½ã",score:4}]},
];

// ============ STATE ============
let selectedPref="";
let selectedRegion="";
let curQ=0, totalScore=0, answers={};

// ============ VIEWS ============
function hide(...ids){ids.forEach(i=>document.getElementById(i).classList.add("hidden"))}
function show(...ids){ids.forEach(i=>document.getElementById(i).classList.remove("hidden"))}

function startQuiz(){
  hide("v-start","v-result","v-quiz","v-allmap");
  show("v-pref");
  renderPrefSelector();
  window.scrollTo({top:0,behavior:"smooth"});
}

function renderPrefSelector(){
  const el=document.getElementById("v-pref");
  let html=`<div class="pref-sec">
    <span class="q-num">STEP 1</span>
    <p class="q-txt">ãŠä½ã¾ã„ã®éƒ½é“åºœçœŒã‚’é¸ã‚“ã§ãã ã•ã„</p>`;
  for(const[key,r] of Object.entries(REGIONS)){
    html+=`<div class="pref-region"><div class="pref-region-name">${r.name}</div><div class="pref-grid">`;
    r.prefs.forEach(p=>{
      html+=`<button class="pref-btn" data-pref="${p}" onclick="selectPref(this,'${p}','${key}')">${p.replace(/çœŒ|åºœ|éƒ½/,"")}</button>`;
    });
    html+=`</div></div>`;
  }
  html+=`</div>`;
  el.innerHTML=html;
}

function selectPref(btn,pref,region){
  document.querySelectorAll(".pref-btn").forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedPref=pref;
  selectedRegion=region;
  // small delay then go to questions
  setTimeout(()=>{
    hide("v-pref");show("v-quiz");
    curQ=0;totalScore=0;answers={};
    renderQ();
  },300);
}

function renderQ(){
  const q=questions[curQ],total=questions.length;
  const pct=Math.round(((curQ)/total)*100);
  document.getElementById("p-txt").textContent=`è³ªå• ${curQ+1} / ${total}`;
  document.getElementById("p-pct").textContent=pct+"%";
  document.getElementById("p-fill").style.width=pct+"%";
  document.getElementById("q-box").innerHTML=`
    <div class="q-sec">
      <span class="q-num">Q${curQ+1}</span>
      <p class="q-txt">${q.text}</p>
      <div class="opts">${q.options.map(o=>`
        <button class="opt-btn" onclick="answer('${q.id}',${o.score})">
          <span class="oi">${o.icon}</span><span class="ol">${o.label}</span>
        </button>`).join("")}
      </div>
    </div>`;
}

function answer(id,score){
  answers[id]=score;totalScore+=score;curQ++;
  if(curQ<questions.length) renderQ(); else showResult();
}

function getLevel(s){
  if(s<=10) return "entry";
  if(s<=14) return "beginner";
  if(s<=19) return "intermediate";
  if(s<=24) return "advanced";
  return "expert";
}

// ============ PREF MATCHING & NEARBY LOGIC ============
function matchPref(course,pref){
  if(Array.isArray(course.pref)) return course.pref.includes(pref);
  return course.pref===pref;
}
function dedup(arr){
  const seen=new Set();
  return arr.filter(c=>{if(seen.has(c.name))return false;seen.add(c.name);return true;});
}

function getNearbyPrefExtras(pref,level){
  const adjPrefs=PREF_ADJACENT[pref]||[];
  let extras=[];
  // å±±å²³ã‚³ãƒ¼ã‚¹: éš£æ¥çœŒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãƒ”ãƒƒã‚¯
  adjPrefs.forEach(ap=>{
    for(const[rk,rv] of Object.entries(mountainDB)){
      const d=rv[level]; if(!d) continue;
      const all=[...(d.popular||[]),...(d.niche||[])].filter(c=>matchPref(c,ap));
      if(all.length>0){
        const pick=all[Math.floor(Math.random()*all.length)];
        extras.push({...pick, _fromPref:ap});
      }
    }
  });
  // æ•£ç­–è·¯: éš£æ¥çœŒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãƒ”ãƒƒã‚¯
  adjPrefs.forEach(ap=>{
    const s=prefStrollDB[ap]||[];
    if(s.length>0){
      const pick=s[Math.floor(Math.random()*s.length)];
      extras.push({...pick, _fromPref:ap});
    }
  });
  return dedup(extras).slice(0,6);
}

// ============ RENDER RESULT ============
function renderCard(c,color){
  const isStroll=c.difficulty==="æ•£ç­–";
  const headerColor=isStroll?"linear-gradient(135deg,#00796b,#26a69a)":color;
  const badge=c.niche?'<span class="niche-b">ç©´å ´</span>':isStroll?'<span class="stroll-b">æ•£ç­–è·¯</span>':'';
  const ss=getSeasonScore(c);
  const hl=getHighlightText(c);
  let siHtml='';
  if(ss===3) siHtml=`<div class="season-indicator"><span class="si-badge si-highlight">ğŸ”¥ ä»ŠãŒæ—¬ï¼</span><span class="highlight-text">${hl}</span></div>`;
  else if(ss===2) siHtml=`<div class="season-indicator"><span class="si-badge si-best">âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³</span></div>`;
  else if(ss===1) siHtml=`<div class="season-indicator"><span class="si-badge si-ok">âœ… ä»ŠæœˆOK</span></div>`;
  else siHtml=`<div class="season-indicator"><span class="si-badge si-offseason">â¸ï¸ ã‚·ãƒ¼ã‚ºãƒ³å¤–</span></div>`;
  return `<div class="card" style="${ss===0?'opacity:.6':''}">
    <div class="card-h" style="background:${headerColor}">
      <h3>${c.name}${badge}${ss===3?'<span class="now-tag">NOW</span>':''}</h3>
      <span class="diff-tag">${c.difficulty}</span>
    </div>
    <div class="card-b">
      ${siHtml}
      <div class="c-meta"><span>â±ï¸ ${c.time}</span><span>ğŸ“ ${c.elevation}</span><span>ğŸ“… ${c.season}</span></div>
      <div class="c-tags">${c.tags.map(t=>`<span class="tag ${t.c}">${t.t}</span>`).join("")}</div>
      <p class="c-desc">${c.description}</p>
      <div class="c-tips"><strong>ğŸ’¡ ãƒ„ã‚¦æƒ…å ±ï¼š</strong>${c.tips}</div>
    </div>
  </div>`;
}

function buildSeasonPanel(region, level){
  const m=getCurrentMonth();
  const s=getSeason(m);
  const sl=getSeasonLabel(m);
  const advice=SEASONAL_ADVICE[region]&&SEASONAL_ADVICE[region][m];
  if(!advice) return '';
  const bgClass={spring:"spring-bg",summer:"summer-bg",autumn:"autumn-bg",winter:"winter-bg"}[s];
  const lvWarn=LEVEL_SEASON_WARNINGS[level]&&LEVEL_SEASON_WARNINGS[level][s];
  return `<div class="season-panel">
    <div class="season-header ${bgClass}">
      <span class="s-icon">${advice.icon}</span>
      <div><div class="s-title">${MONTH_NAMES[m]}ï¼ˆ${sl}ï¼‰ã®${selectedPref}ã‚¨ãƒªã‚¢</div>
      <div class="s-month">ä»Šã®æ™‚æœŸã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼†ãŠã™ã™ã‚</div></div>
    </div>
    <div class="season-body">
      <div class="season-summary">${advice.summary}</div>
      <div class="season-warn"><strong>âš ï¸ æ³¨æ„ï¼š</strong>${advice.warn}</div>
      <div class="season-recommend"><strong>ğŸŒŸ ä»Šæœˆã®ãŠã™ã™ã‚ï¼š</strong>${advice.recommend}</div>
      ${lvWarn?`<div class="level-season-note"><strong>ğŸ“‹ ${LEVEL_META[level].level}ãƒ¬ãƒ™ãƒ«ã®æ–¹ã¸ï¼š</strong>${lvWarn}</div>`:''}
    </div>
  </div>`;
}

function showResult(){
  hide("v-quiz","v-allmap");show("v-result");
  window.scrollTo({top:0,behavior:"smooth"});
  // åœ°å›³ãƒªã‚»ãƒƒãƒˆ
  if(mapInstance){mapInstance.remove();mapInstance=null;markerLayer=null;}

  const level=getLevel(totalScore);
  const meta=LEVEL_META[level];
  const color=LEVEL_COLORS[level];

  // å…¨åœ°åŸŸã‹ã‚‰ selectedPref ã«ãƒãƒƒãƒã™ã‚‹å±±å²³ã‚³ãƒ¼ã‚¹ã‚’åé›†
  let pop=[],niche=[];
  for(const[rk,rv] of Object.entries(mountainDB)){
    const d=rv[level]; if(!d) continue;
    pop.push(...(d.popular||[]).filter(c=>matchPref(c,selectedPref)));
    niche.push(...(d.niche||[]).filter(c=>matchPref(c,selectedPref)));
  }
  pop=dedup(pop); niche=dedup(niche);
  const strolls=prefStrollDB[selectedPref]||[];
  const nearby=getNearbyPrefExtras(selectedPref,level);
  mapCourses={pop,niche,strolls,nearby};

  // ã€Œä»ŠãŒæ—¬ã€ã‚³ãƒ¼ã‚¹ï¼ˆã‚¹ã‚³ã‚¢2ä»¥ä¸Šã®ã‚‚ã®ã‚’ã‚¹ã‚³ã‚¢é™é †ã§ã‚½ãƒ¼ãƒˆï¼‰
  const allCourses=[...pop,...niche,...strolls];
  const nowPicks=allCourses.filter(c=>getSeasonScore(c)>=2).sort((a,b)=>getSeasonScore(b)-getSeasonScore(a));

  const allLocal=[...pop,...niche];
  const hasMountain=allLocal.length>0;
  const totalAll=allLocal.length+nearby.length+strolls.length;

  const seasonPanel=buildSeasonPanel(selectedRegion,level);

  // è¿‘éš£çœŒåãƒªã‚¹ãƒˆï¼ˆé‡è¤‡æ’é™¤ï¼‰
  const nearbyPrefs=[...new Set(nearby.map(c=>c._fromPref))];

  let html=`<div class="r-sec">
    <span class="r-badge lv-${level}">ğŸ¯ ã‚ãªãŸã¯ã€Œ${meta.level}ã€ãƒ¬ãƒ™ãƒ«</span>
    <div class="r-region">ğŸ“ ${selectedPref} ã®ãŠã™ã™ã‚</div>
    <div class="r-sum"><p>${meta.message}</p></div>
    ${seasonPanel}
    ${!hasMountain?`<div class="stroll-note" style="background:#e3f2fd;color:#1565c0"><strong>â„¹ï¸ ${selectedPref}ã«ã¯æ²è¼‰ä¸­ã®ç™»å±±ã‚³ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</strong>æ•£ç­–è·¯ã¨è¿‘éš£çœŒã®ã‚³ãƒ¼ã‚¹ã‚’ã”è¦§ãã ã•ã„ï¼</div>`:''}
    <div class="tabs">
      <div class="tab-btns">
        ${nowPicks.length?`<button class="tab-b active" onclick="sw(event,'t-now')">ğŸ”¥ ä»ŠãŒæ—¬ (${nowPicks.length})</button>`:''}
        <button class="tab-b ${nowPicks.length?'':'active'}" onclick="sw(event,'t-all')">ã™ã¹ã¦ (${totalAll})</button>
        ${hasMountain?`<button class="tab-b" onclick="sw(event,'t-pop')">å®šç•ª (${pop.length})</button>`:''}
        ${hasMountain?`<button class="tab-b" onclick="sw(event,'t-niche')">ç©´å ´ (${niche.length})</button>`:''}
        <button class="tab-b" onclick="sw(event,'t-stroll')">æ•£ç­–è·¯ (${strolls.length})</button>
        ${nearby.length?`<button class="tab-b" onclick="sw(event,'t-near')">è¿‘éš£çœŒ (${nearby.length})</button>`:''}
        <button class="tab-b" onclick="sw(event,'t-map')">ğŸ—ºï¸ åœ°å›³</button>
      </div>
      ${nowPicks.length?`<div id="t-now" class="tab-c active"><div class="cards">
        <div class="stroll-note" style="background:#fff3e0;color:#e65100"><strong>ğŸ”¥ ${MONTH_NAMES[getCurrentMonth()]}ã«è¡Œããªã‚‰ã“ã“ï¼</strong> â€” ä»Šã¾ã•ã«ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³ï¼†è¦‹ã©ã“ã‚ãŒã‚ã‚‹ã‚³ãƒ¼ã‚¹ã‚’å³é¸</div>
        ${nowPicks.map(c=>renderCard(c,color)).join("")}
      </div></div>`:''}
      <div id="t-all" class="tab-c ${nowPicks.length?'':'active'}"><div class="cards">
        ${allLocal.map(c=>renderCard(c,color)).join("")}
        ${strolls.length?`<div class="stroll-note"><strong>ğŸŒ¿ è‡ªç„¶æ•£ç­–è·¯</strong> â€” ç§æœOKãƒ»è¦³å…‰ãƒ—ãƒ©ãƒ³ã«çµ„ã¿è¾¼ã‚ã‚‹ãŠæ‰‹è»½ã‚³ãƒ¼ã‚¹</div>`:''}
        ${strolls.map(c=>renderCard(c,color)).join("")}
        ${nearby.length?`<div class="nearby-note"><strong>ğŸš— è¿‘éš£çœŒã®ãŠã™ã™ã‚</strong>ï¼ˆå°‘ã—è¶³ã‚’å»¶ã°ã›ã°è¡Œã‘ã‚‹ã‚³ãƒ¼ã‚¹ï¼‰</div>`:''}
        ${nearby.map(c=>renderCard(c,color)).join("")}
      </div></div>
      ${hasMountain?`<div id="t-pop" class="tab-c"><div class="cards">${pop.map(c=>renderCard(c,color)).join("")}</div></div>
      <div id="t-niche" class="tab-c"><div class="cards">${niche.map(c=>renderCard(c,color)).join("")}</div></div>`:''}
      <div id="t-stroll" class="tab-c"><div class="cards">
        <div class="stroll-note"><strong>ğŸŒ¿ è‡ªç„¶æ•£ç­–è·¯</strong> â€” é€šå¸¸ã®ç§æœã§æ¥½ã—ã‚ã‚‹ã€è¦³å…‰ã®ãƒ—ãƒ©ãƒ³ã«ã‚»ãƒƒãƒˆã§çµ„ã¿è¾¼ã‚ã‚‹ã‚³ãƒ¼ã‚¹ã§ã™ã€‚ç™»å±±è£…å‚™ã¯ä¸è¦ã§ã™ã€‚</div>
        ${strolls.map(c=>renderCard(c,color)).join("")}
      </div></div>
      ${nearby.length?`<div id="t-near" class="tab-c"><div class="cards">
        <div class="nearby-note"><strong>ğŸš— è¿‘éš£çœŒã®ãŠã™ã™ã‚</strong>ï¼ˆ${nearbyPrefs.join("ãƒ»")}ã®ã‚³ãƒ¼ã‚¹ï¼‰</div>
        ${nearby.map(c=>renderCard(c,color)).join("")}
      </div></div>`:''}
      <div id="t-map" class="tab-c">
        <div id="map-container"></div>
        <div class="map-legend">
          <div class="map-legend-item"><span class="map-legend-dot" style="background:#2d6a4f"></span>å®šç•ª</div>
          <div class="map-legend-item"><span class="map-legend-dot" style="background:#7b1fa2"></span>ç©´å ´</div>
          <div class="map-legend-item"><span class="map-legend-dot" style="background:#00796b"></span>æ•£ç­–è·¯</div>
          ${nearby.length?`<div class="map-legend-item"><span class="map-legend-dot" style="background:#1565c0"></span>è¿‘éš£çœŒ</div>`:''}
        </div>
      </div>
    </div>
    <button class="btn-restart" onclick="startQuiz()">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
  </div>`;

  document.getElementById("v-result").innerHTML=html;
}

function sw(e,id){
  document.querySelectorAll(".tab-b").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-c").forEach(t=>t.classList.remove("active"));
  e.currentTarget.classList.add("active");
  document.getElementById(id).classList.add("active");
  if(id==='t-map') initMap();
}

// ============ MAP ============
let mapCourses={pop:[],niche:[],strolls:[],nearby:[]};
let mapInstance=null;
let markerLayer=null;

function initMap(){
  if(mapInstance){setTimeout(()=>mapInstance.invalidateSize(),100);return;}
  try{
    const center=PREF_CENTER[selectedPref]||{lat:36.2,lng:138.25};
    mapInstance=L.map('map-container').setView([center.lat,center.lng],9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom:18
    }).addTo(mapInstance);
    markerLayer=L.markerClusterGroup({showCoverageOnHover:false});
    const{pop,niche,strolls,nearby}=mapCourses;
    pop.forEach(c=>addCourseMarker(c,'#2d6a4f','å®šç•ª'));
    niche.forEach(c=>addCourseMarker(c,'#7b1fa2','ç©´å ´'));
    strolls.forEach(c=>addCourseMarker(c,'#00796b','æ•£ç­–è·¯'));
    nearby.forEach(c=>addCourseMarker(c,'#1565c0','è¿‘éš£çœŒ'));
    mapInstance.addLayer(markerLayer);
    if(markerLayer.getLayers().length>0){
      mapInstance.fitBounds(markerLayer.getBounds(),{padding:[30,30]});
    }
    setTimeout(()=>mapInstance.invalidateSize(),200);
  }catch(e){
    document.getElementById('map-container').innerHTML='<div style="padding:40px;text-align:center;color:#999">ğŸ—ºï¸ åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';
  }
}

function addCourseMarker(course,color,category){
  const loc=getCourseLocation(course);
  if(!loc) return;
  const icon=L.divIcon({
    className:'',
    html:`<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4)"></div>`,
    iconSize:[14,14],iconAnchor:[7,7]
  });
  const ss=getSeasonScore(course);
  const sl=ss===3?'ğŸ”¥ ä»ŠãŒæ—¬ï¼':ss===2?'âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³':ss===1?'âœ… ä»ŠæœˆOK':'â¸ï¸ ã‚·ãƒ¼ã‚ºãƒ³å¤–';
  const fromPref=course._fromPref?`<br>ğŸ“ ${course._fromPref}`:'';
  const popup=`<div class="map-popup-title">${course.name}</div>
    <div class="map-popup-meta">${category}ãƒ»${course.difficulty}${fromPref}<br>â±ï¸${course.time}ãƒ»ğŸ“${course.elevation}<br>ğŸ“…${course.season}</div>
    <div class="map-popup-season">${sl}</div>`;
  markerLayer.addLayer(L.marker([loc.lat,loc.lng],{icon}).bindPopup(popup,{maxWidth:250}));
}

// ============ ALL COURSES MAP ============
let allMapInstance=null;
let allMapMarkerLayer=null;
let allCoursesCache=null;
let allMapFilters={type:"all",diff:"all"};

const DIFF_KEY_MAP={"å…¥é–€":"entry","åˆç´š":"beginner","ä¸­ç´š":"intermediate","ä¸Šç´š":"advanced","ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ":"expert","ä¸­ç´šã€œä¸Šç´š":"intermediate_advanced","æ•£ç­–":"stroll"};

function getAllCourses(){
  if(allCoursesCache) return allCoursesCache;
  const all=[];
  const seen=new Set();
  for(const[rk,rv] of Object.entries(mountainDB)){
    for(const[level,ld] of Object.entries(rv)){
      for(const c of (ld.popular||[])){
        if(!seen.has(c.name)){seen.add(c.name);all.push(Object.assign({},c,{_category:c.niche?"niche":"popular",_level:level}));}
      }
      for(const c of (ld.niche||[])){
        if(!seen.has(c.name)){seen.add(c.name);all.push(Object.assign({},c,{_category:"niche",_level:level}));}
      }
    }
  }
  for(const[pref,courses] of Object.entries(prefStrollDB)){
    for(const c of courses){
      if(!seen.has(c.name)){seen.add(c.name);all.push(Object.assign({},c,{_category:"stroll",_level:"stroll"}));}
    }
  }
  allCoursesCache=all;
  return all;
}

function showAllMap(){
  hide("v-start","v-pref","v-quiz","v-result");
  show("v-allmap");
  window.scrollTo({top:0,behavior:"smooth"});
  setTimeout(()=>initAllMap(),100);
}

function backToStart(){
  hide("v-allmap","v-pref","v-quiz","v-result");
  show("v-start");
  window.scrollTo({top:0,behavior:"smooth"});
}

function toggleAllMapFilter(btn,group){
  btn.parentElement.querySelectorAll(".allmap-fbtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  allMapFilters[group]=btn.dataset.val;
  updateAllMapMarkers();
}

function initAllMap(){
  if(allMapInstance){allMapInstance.invalidateSize();return;}
  try{
    allMapInstance=L.map('allmap-container').setView([36.2,138.25],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom:18
    }).addTo(allMapInstance);
    allMapMarkerLayer=L.markerClusterGroup({showCoverageOnHover:false});
    allMapInstance.addLayer(allMapMarkerLayer);
    updateAllMapMarkers();
    setTimeout(()=>allMapInstance.invalidateSize(),200);
  }catch(e){
    document.getElementById('allmap-container').innerHTML='<div style="padding:40px;text-align:center;color:#999">ğŸ—ºï¸ åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</div>';
  }
}

function updateAllMapMarkers(){
  if(!allMapMarkerLayer) return;
  allMapMarkerLayer.clearLayers();
  const courses=getAllCourses();
  const{type,diff}=allMapFilters;
  let count=0;
  const COLORS={popular:"#2d6a4f",niche:"#7b1fa2",stroll:"#00796b"};

  courses.forEach(c=>{
    if(type!=="all"&&c._category!==type) return;
    if(diff!=="all"){
      if(diff==="stroll"){if(c._level!=="stroll") return;}
      else{
        const dk=DIFF_KEY_MAP[c.difficulty]||c._level;
        if(dk==="intermediate_advanced"){if(diff!=="intermediate"&&diff!=="advanced") return;}
        else if(c._level!==diff) return;
      }
    }
    const loc=getCourseLocation(c);
    if(!loc) return;
    const color=COLORS[c._category]||"#2d6a4f";
    const icon=L.divIcon({className:'',
      html:`<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.4)"></div>`,
      iconSize:[14,14],iconAnchor:[7,7]});
    const ss=getSeasonScore(c);
    const sl=ss===3?'ğŸ”¥ ä»ŠãŒæ—¬ï¼':ss===2?'âœ¨ ãƒ™ã‚¹ãƒˆã‚·ãƒ¼ã‚ºãƒ³':ss===1?'âœ… ä»ŠæœˆOK':'â¸ï¸ ã‚·ãƒ¼ã‚ºãƒ³å¤–';
    const prefStr=Array.isArray(c.pref)?c.pref.join('ãƒ»'):c.pref;
    const catLabel=c._category==="niche"?"ç©´å ´":c._category==="stroll"?"æ•£ç­–è·¯":"å®šç•ª";
    const popup=`<div class="map-popup-title">${c.name}</div>
      <div class="map-popup-meta">${catLabel}ãƒ»${c.difficulty}<br>ğŸ“ ${prefStr}<br>â±ï¸ ${c.time}ãƒ»ğŸ“ ${c.elevation}<br>ğŸ“… ${c.season}</div>
      <div class="map-popup-season">${sl}</div>`;
    allMapMarkerLayer.addLayer(L.marker([loc.lat,loc.lng],{icon}).bindPopup(popup,{maxWidth:250}));
    count++;
  });

  const el=document.getElementById('allmap-count');
  if(el) el.textContent=`è¡¨ç¤ºä¸­: ${count}ã‚³ãƒ¼ã‚¹`;
}
</script>
</body>
</html>
